# .github/workflows/update-laws.yml
name: ğŸ‡ªğŸ‡º EU-Gesetze Auto-Update

on:
  # TÃ¤glich um 6:00 Uhr MEZ
  schedule:
    - cron: '0 4 * * *'  # 4 UTC = 6 MEZ im Winter, 5 MEZ im Sommer
  
  # Manuell auslÃ¶sbar Ã¼ber GitHub Interface
  workflow_dispatch:
  
  # Bei Push auf main branch (fÃ¼r Tests)
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-laws.yml'

permissions:
  contents: write  # ErmÃ¶glicht das Schreiben in das Repository

jobs:
  update-eu-laws:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Repository auschecken
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“ Laws-Ordner vorbereiten
      run: |
        # Entferne existing laws falls es eine Datei ist
        if [ -f laws ]; then
          echo "âš ï¸ 'laws' ist eine Datei - wird gelÃ¶scht"
          rm laws
        fi
        
        # Erstelle laws Ordner falls er nicht existiert
        if [ ! -d laws ]; then
          echo "ğŸ“ Erstelle laws Ordner"
          mkdir laws
        else
          echo "âœ… laws Ordner existiert bereits"
        fi
        
        # Bereinige alte Dateien (optional)
        echo "ğŸ§¹ Bereinige laws Ordner"
        rm -f laws/*.html
      
    - name: ğŸ›ï¸ EU-GeldwÃ¤scheverordnung 2024 herunterladen
      run: |
        echo "ğŸ“¥ Lade EU-GeldwÃ¤scheverordnung 2024..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://eur-lex.europa.eu/legal-content/DE/TXT/HTML/?uri=CELEX:32024R1624" \
          -o laws/eu-aml-2024.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        # PrÃ¼fe ob Datei gÃ¼ltig ist
        if [ -f laws/eu-aml-2024.html ] && [ $(wc -c < laws/eu-aml-2024.html) -gt 10000 ]; then
          echo "âœ… EU-GeldwÃ¤scheverordnung erfolgreich geladen: $(wc -c < laws/eu-aml-2024.html) Bytes"
        else
          echo "âŒ EU-GeldwÃ¤scheverordnung Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ”’ EU-Datenschutz-Grundverordnung (GDPR) herunterladen
      run: |
        echo "ğŸ“¥ Lade GDPR..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://eur-lex.europa.eu/legal-content/DE/TXT/HTML/?uri=CELEX:32016R0679" \
          -o laws/eu-gdpr-2016.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/eu-gdpr-2016.html ] && [ $(wc -c < laws/eu-gdpr-2016.html) -gt 10000 ]; then
          echo "âœ… GDPR erfolgreich geladen: $(wc -c < laws/eu-gdpr-2016.html) Bytes"
        else
          echo "âŒ GDPR Download fehlgeschlagen"
          exit 1
        fi
        
    - name: ğŸ¤– EU-KI-Verordnung (AI Act) herunterladen
      run: |
        echo "ğŸ“¥ Lade AI Act..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://eur-lex.europa.eu/legal-content/DE/TXT/HTML/?uri=CELEX:32024R1689" \
          -o laws/eu-ai-act-2024.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/eu-ai-act-2024.html ] && [ $(wc -c < laws/eu-ai-act-2024.html) -gt 10000 ]; then
          echo "âœ… AI Act erfolgreich geladen: $(wc -c < laws/eu-ai-act-2024.html) Bytes"
        else
          echo "âŒ AI Act Download fehlgeschlagen"
          exit 1
        fi
        
    - name: ğŸŒ Digital Services Act (DSA) herunterladen
      run: |
        echo "ğŸ“¥ Lade DSA..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://eur-lex.europa.eu/legal-content/DE/TXT/HTML/?uri=CELEX:32022R2065" \
          -o laws/eu-dsa-2022.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/eu-dsa-2022.html ] && [ $(wc -c < laws/eu-dsa-2022.html) -gt 10000 ]; then
          echo "âœ… DSA erfolgreich geladen: $(wc -c < laws/eu-dsa-2022.html) Bytes"
        else
          echo "âŒ DSA Download fehlgeschlagen"
          exit 1
        fi

    # ===== DEUTSCHE GESETZE - GELDWÃ„SCHEPRÃ„VENTION & SANKTIONEN =====
    
    - name: ğŸ¦ GeldwÃ¤schegesetz (GwG) herunterladen
      run: |
        echo "ğŸ“¥ Lade GeldwÃ¤schegesetz (GwG)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/gwg_2017/BJNR182210017.html" \
          -o laws/de-gwg-2017.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-gwg-2017.html ] && [ $(wc -c < laws/de-gwg-2017.html) -gt 5000 ]; then
          echo "âœ… GeldwÃ¤schegesetz erfolgreich geladen: $(wc -c < laws/de-gwg-2017.html) Bytes"
        else
          echo "âŒ GeldwÃ¤schegesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ›ï¸ Kreditwesengesetz (KWG) herunterladen
      run: |
        echo "ğŸ“¥ Lade Kreditwesengesetz (KWG)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/kwg/BJNR008810961.html" \
          -o laws/de-kwg.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-kwg.html ] && [ $(wc -c < laws/de-kwg.html) -gt 5000 ]; then
          echo "âœ… Kreditwesengesetz erfolgreich geladen: $(wc -c < laws/de-kwg.html) Bytes"
        else
          echo "âŒ Kreditwesengesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ’³ Zahlungsdiensteaufsichtsgesetz (ZAG) herunterladen
      run: |
        echo "ğŸ“¥ Lade Zahlungsdiensteaufsichtsgesetz (ZAG)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/zag_2018/BJNR194710017.html" \
          -o laws/de-zag-2018.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-zag-2018.html ] && [ $(wc -c < laws/de-zag-2018.html) -gt 5000 ]; then
          echo "âœ… Zahlungsdiensteaufsichtsgesetz erfolgreich geladen: $(wc -c < laws/de-zag-2018.html) Bytes"
        else
          echo "âŒ Zahlungsdiensteaufsichtsgesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸŒ AuÃŸenwirtschaftsgesetz (AWG) herunterladen
      run: |
        echo "ğŸ“¥ Lade AuÃŸenwirtschaftsgesetz (AWG)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/awg/BJNR107740961.html" \
          -o laws/de-awg.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-awg.html ] && [ $(wc -c < laws/de-awg.html) -gt 5000 ]; then
          echo "âœ… AuÃŸenwirtschaftsgesetz erfolgreich geladen: $(wc -c < laws/de-awg.html) Bytes"
        else
          echo "âŒ AuÃŸenwirtschaftsgesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ“‹ AuÃŸenwirtschaftsverordnung (AWV) herunterladen
      run: |
        echo "ğŸ“¥ Lade AuÃŸenwirtschaftsverordnung (AWV)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/awv_2013/BJNR144610013.html" \
          -o laws/de-awv-2013.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-awv-2013.html ] && [ $(wc -c < laws/de-awv-2013.html) -gt 5000 ]; then
          echo "âœ… AuÃŸenwirtschaftsverordnung erfolgreich geladen: $(wc -c < laws/de-awv-2013.html) Bytes"
        else
          echo "âŒ AuÃŸenwirtschaftsverordnung Download fehlgeschlagen"
          exit 1
        fi
    
    - name: âš–ï¸ Strafgesetzbuch (StGB) - GeldwÃ¤sche Â§261 herunterladen
      run: |
        echo "ğŸ“¥ Lade Strafgesetzbuch (StGB)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/stgb/BJNR001270871.html" \
          -o laws/de-stgb.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-stgb.html ] && [ $(wc -c < laws/de-stgb.html) -gt 5000 ]; then
          echo "âœ… Strafgesetzbuch erfolgreich geladen: $(wc -c < laws/de-stgb.html) Bytes"
        else
          echo "âŒ Strafgesetzbuch Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ›¡ï¸ Versicherungsaufsichtsgesetz (VAG) herunterladen
      run: |
        echo "ğŸ“¥ Lade Versicherungsaufsichtsgesetz (VAG)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/vag_2016/BJNR043410015.html" \
          -o laws/de-vag-2016.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-vag-2016.html ] && [ $(wc -c < laws/de-vag-2016.html) -gt 5000 ]; then
          echo "âœ… Versicherungsaufsichtsgesetz erfolgreich geladen: $(wc -c < laws/de-vag-2016.html) Bytes"
        else
          echo "âŒ Versicherungsaufsichtsgesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ’¼ Kapitalanlagegesetzbuch (KAGB) herunterladen
      run: |
        echo "ğŸ“¥ Lade Kapitalanlagegesetzbuch (KAGB)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/kagb/BJNR081010013.html" \
          -o laws/de-kagb.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-kagb.html ] && [ $(wc -c < laws/de-kagb.html) -gt 5000 ]; then
          echo "âœ… Kapitalanlagegesetzbuch erfolgreich geladen: $(wc -c < laws/de-kagb.html) Bytes"
        else
          echo "âŒ Kapitalanlagegesetzbuch Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ“ˆ Wertpapierhandelsgesetz (WpHG) herunterladen
      run: |
        echo "ğŸ“¥ Lade Wertpapierhandelsgesetz (WpHG)..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/wphg/BJNR024520007.html" \
          -o laws/de-wphg.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-wphg.html ] && [ $(wc -c < laws/de-wphg.html) -gt 5000 ]; then
          echo "âœ… Wertpapierhandelsgesetz erfolgreich geladen: $(wc -c < laws/de-wphg.html) Bytes"
        else
          echo "âŒ Wertpapierhandelsgesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ‡ªğŸ‡º EU-Sanktions-DurchfÃ¼hrungsgesetz herunterladen
      run: |
        echo "ğŸ“¥ Lade EU-Sanktions-DurchfÃ¼hrungsgesetz..."
        curl -L -A "Mozilla/5.0 (GitHub-Actions)" \
          "https://www.gesetze-im-internet.de/eusanktdg/BJNR281010992.html" \
          -o laws/de-eu-sanktdg.html \
          --connect-timeout 30 \
          --max-time 300 \
          --retry 3
        
        if [ -f laws/de-eu-sanktdg.html ] && [ $(wc -c < laws/de-eu-sanktdg.html) -gt 5000 ]; then
          echo "âœ… EU-Sanktions-DurchfÃ¼hrungsgesetz erfolgreich geladen: $(wc -c < laws/de-eu-sanktdg.html) Bytes"
        else
          echo "âŒ EU-Sanktions-DurchfÃ¼hrungsgesetz Download fehlgeschlagen"
          exit 1
        fi
    
    - name: ğŸ“Š Update-Metadaten erstellen
      run: |
        echo "ğŸ“Š Erstelle Metadaten..."
        cat > laws/last-update.json << 'EOF'
        {
          "last_update": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "laws": {
            "eu-aml-2024": {
              "name": "EU-GeldwÃ¤scheverordnung 2024",
              "celex": "32024R1624",
              "file": "eu-aml-2024.html",
              "type": "eu-regulation",
              "size": $(wc -c < laws/eu-aml-2024.html)
            },
            "eu-gdpr-2016": {
              "name": "EU-Datenschutz-Grundverordnung",
              "celex": "32016R0679", 
              "file": "eu-gdpr-2016.html",
              "type": "eu-regulation",
              "size": $(wc -c < laws/eu-gdpr-2016.html)
            },
            "eu-ai-act-2024": {
              "name": "EU-KI-Verordnung (AI Act)",
              "celex": "32024R1689",
              "file": "eu-ai-act-2024.html",
              "type": "eu-regulation", 
              "size": $(wc -c < laws/eu-ai-act-2024.html)
            },
            "eu-dsa-2022": {
              "name": "Digital Services Act",
              "celex": "32022R2065",
              "file": "eu-dsa-2022.html",
              "type": "eu-regulation",
              "size": $(wc -c < laws/eu-dsa-2022.html)
            },
            "de-gwg-2017": {
              "name": "GeldwÃ¤schegesetz (GwG)",
              "file": "de-gwg-2017.html",
              "type": "german-law",
              "category": "aml",
              "size": $(wc -c < laws/de-gwg-2017.html)
            },
            "de-kwg": {
              "name": "Kreditwesengesetz (KWG)",
              "file": "de-kwg.html",
              "type": "german-law",
              "category": "banking",
              "size": $(wc -c < laws/de-kwg.html)
            },
            "de-zag-2018": {
              "name": "Zahlungsdiensteaufsichtsgesetz (ZAG)",
              "file": "de-zag-2018.html",
              "type": "german-law",
              "category": "payments",
              "size": $(wc -c < laws/de-zag-2018.html)
            },
            "de-awg": {
              "name": "AuÃŸenwirtschaftsgesetz (AWG)",
              "file": "de-awg.html",
              "type": "german-law",
              "category": "sanctions",
              "size": $(wc -c < laws/de-awg.html)
            },
            "de-awv-2013": {
              "name": "AuÃŸenwirtschaftsverordnung (AWV)",
              "file": "de-awv-2013.html",
              "type": "german-law",
              "category": "sanctions",
              "size": $(wc -c < laws/de-awv-2013.html)
            },
            "de-stgb": {
              "name": "Strafgesetzbuch (StGB)",
              "file": "de-stgb.html",
              "type": "german-law",
              "category": "criminal",
              "size": $(wc -c < laws/de-stgb.html)
            },
            "de-vag-2016": {
              "name": "Versicherungsaufsichtsgesetz (VAG)",
              "file": "de-vag-2016.html",
              "type": "german-law",
              "category": "insurance",
              "size": $(wc -c < laws/de-vag-2016.html)
            },
            "de-kagb": {
              "name": "Kapitalanlagegesetzbuch (KAGB)",
              "file": "de-kagb.html",
              "type": "german-law",
              "category": "investments",
              "size": $(wc -c < laws/de-kagb.html)
            },
            "de-wphg": {
              "name": "Wertpapierhandelsgesetz (WpHG)",
              "file": "de-wphg.html",
              "type": "german-law",
              "category": "securities",
              "size": $(wc -c < laws/de-wphg.html)
            },
            "de-eu-sanktdg": {
              "name": "EU-Sanktions-DurchfÃ¼hrungsgesetz",
              "file": "de-eu-sanktdg.html",
              "type": "german-law",
              "category": "sanctions",
              "size": $(wc -c < laws/de-eu-sanktdg.html)
            }
          }
        }
        EOF
        
        # Ersetze die Variablen
        sed -i "s/\$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")/$(date -u +"%Y-%m-%dT%H:%M:%SZ")/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/eu-aml-2024.html)/$(wc -c < laws/eu-aml-2024.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/eu-gdpr-2016.html)/$(wc -c < laws/eu-gdpr-2016.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/eu-ai-act-2024.html)/$(wc -c < laws/eu-ai-act-2024.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/eu-dsa-2022.html)/$(wc -c < laws/eu-dsa-2022.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-gwg-2017.html)/$(wc -c < laws/de-gwg-2017.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-kwg.html)/$(wc -c < laws/de-kwg.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-zag-2018.html)/$(wc -c < laws/de-zag-2018.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-awg.html)/$(wc -c < laws/de-awg.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-awv-2013.html)/$(wc -c < laws/de-awv-2013.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-stgb.html)/$(wc -c < laws/de-stgb.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-vag-2016.html)/$(wc -c < laws/de-vag-2016.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-kagb.html)/$(wc -c < laws/de-kagb.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-wphg.html)/$(wc -c < laws/de-wphg.html)/g" laws/last-update.json
        sed -i "s/\$(wc -c < laws\/de-eu-sanktdg.html)/$(wc -c < laws/de-eu-sanktdg.html)/g" laws/last-update.json
        
        echo "âœ… Metadaten erstellt:"
        cat laws/last-update.json
    
    - name: ğŸ” Ã„nderungen prÃ¼fen
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Ã„nderungen an den Gesetzen erkannt:"
          git status --porcelain
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "âœ… Keine Ã„nderungen erkannt - Gesetze sind aktuell"
        fi
    
    - name: ğŸ’¾ Ã„nderungen committen und pushen
      if: steps.changes.outputs.changes_detected == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "EU-Laws Auto-Update Bot"
        
        git add laws/
        git commit -m "ğŸ¤– Automatisches Update der EU-Gesetze - $(date +'%Y-%m-%d %H:%M')"
        
        echo "ğŸš€ Pushe Updates zum Repository..."
        git push
        
        echo "âœ… EU-Gesetze erfolgreich aktualisiert und gepusht!"
    
    - name: ğŸ“§ Benachrichtigung bei Ã„nderungen (optional)
      if: steps.changes.outputs.changes_detected == 'true'
      run: |
        echo "ğŸ“§ Neue Gesetzesversionen verfÃ¼gbar!"
        echo "Die folgenden EU-Gesetze wurden aktualisiert:"
        echo "- EU-GeldwÃ¤scheverordnung 2024"
        echo "- EU-Datenschutz-Grundverordnung"  
        echo "- EU-KI-Verordnung (AI Act)"
        echo "- Digital Services Act"
        echo ""
        echo "ğŸ”— Siehe: https://github.com/${{ github.repository }}/tree/main/laws"
        
        # Hier kÃ¶nnten Sie spÃ¤ter E-Mail oder Slack-Benachrichtigungen hinzufÃ¼gen
    
    - name: âœ… Workflow-Zusammenfassung
      run: |
        echo "ğŸ‰ EU-Gesetze und deutsche Gesetze Auto-Update abgeschlossen!"
        echo ""
        echo "ğŸ“Š EU-Verordnungen:"
        echo "- EU-GeldwÃ¤scheverordnung: $(wc -c < laws/eu-aml-2024.html) Bytes"
        echo "- GDPR: $(wc -c < laws/eu-gdpr-2016.html) Bytes"  
        echo "- AI Act: $(wc -c < laws/eu-ai-act-2024.html) Bytes"
        echo "- DSA: $(wc -c < laws/eu-dsa-2022.html) Bytes"
        echo ""
        echo "ğŸ“Š Deutsche Gesetze - GeldwÃ¤scheprÃ¤vention & Sanktionen:"
        echo "- GeldwÃ¤schegesetz (GwG): $(wc -c < laws/de-gwg-2017.html) Bytes"
        echo "- Kreditwesengesetz (KWG): $(wc -c < laws/de-kwg.html) Bytes"
        echo "- Zahlungsdiensteaufsichtsgesetz (ZAG): $(wc -c < laws/de-zag-2018.html) Bytes"
        echo "- AuÃŸenwirtschaftsgesetz (AWG): $(wc -c < laws/de-awg.html) Bytes"
        echo "- AuÃŸenwirtschaftsverordnung (AWV): $(wc -c < laws/de-awv-2013.html) Bytes"
        echo "- Strafgesetzbuch (StGB): $(wc -c < laws/de-stgb.html) Bytes"
        echo "- Versicherungsaufsichtsgesetz (VAG): $(wc -c < laws/de-vag-2016.html) Bytes"
        echo "- Kapitalanlagegesetzbuch (KAGB): $(wc -c < laws/de-kagb.html) Bytes"
        echo "- Wertpapierhandelsgesetz (WpHG): $(wc -c < laws/de-wphg.html) Bytes"
        echo "- EU-Sanktions-DurchfÃ¼hrungsgesetz: $(wc -c < laws/de-eu-sanktdg.html) Bytes"
        echo ""
        echo "â° NÃ¤chstes Update: Morgen um 6:00 Uhr MEZ"
        echo "ğŸ”— VerfÃ¼gbar unter: https://github.com/${{ github.repository }}/tree/main/laws"
