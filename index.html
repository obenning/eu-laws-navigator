<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EU-Gesetzes Navigator - Auto-Updates</title>
    <style>
        .euaml-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .euaml-header {
            background: linear-gradient(135deg, #063AA8 0%, #1E40AF 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .euaml-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .euaml-auto-badge {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .euaml-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .euaml-law-selector {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.2);
            color: #063AA8;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 200px;
        }

        .euaml-refresh-btn {
            background: rgba(34, 197, 94, 0.9);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .euaml-refresh-btn:hover {
            background: rgba(34, 197, 94, 1);
            transform: translateY(-1px);
        }

        .euaml-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .euaml-info-banner {
            background: linear-gradient(90deg, #E0F2FE 0%, #F0F9FF 100%);
            border-bottom: 1px solid #7DD3FC;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #0369A1;
        }

        .euaml-github-link {
            color: #1D4ED8;
            text-decoration: none;
            font-weight: 500;
        }

        .euaml-github-link:hover {
            text-decoration: underline;
        }

        .euaml-search-section {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .euaml-search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #DEE2E6;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .euaml-search-input:focus {
            outline: none;
            border-color: #063AA8;
            box-shadow: 0 0 0 3px rgba(6,58,168,0.1);
        }

        .euaml-main-content {
            overflow-y: auto;
            padding: 15px 20px;
            flex: 1;
        }

        .euaml-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .euaml-section:last-child {
            border-bottom: none;
        }

        .euaml-section-title {
            color: #063AA8;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .euaml-update-time {
            font-size: 11px;
            color: #666;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .euaml-article {
            margin: 8px 0;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .euaml-article:hover {
            background: #F0F5FF;
            border-color: #DEE2E6;
        }

        .euaml-article.euaml-active {
            background: #E6F0FF;
            border-color: #063AA8;
        }

        .euaml-content-match {
            background-color: #f0f7ff;
            border-left: 3px solid #063AA8;
        }

        .euaml-article-title {
            padding: 10px 12px;
            font-weight: 500;
            color: #333;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .euaml-article-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .euaml-article-content {
            display: none;
            padding: 20px;
            background: #FFFFFF;
            border-top: 1px solid #E2E8F0;
            font-size: 14px;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
            user-select: text;
            cursor: text;
        }

        .euaml-article.euaml-active .euaml-article-content {
            display: block;
        }

        .euaml-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #666;
            flex-direction: column;
            gap: 15px;
        }

        .euaml-loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #063AA8;
            border-radius: 50%;
            animation: euaml-spin 1s linear infinite;
        }

        @keyframes euaml-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .euaml-error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #e53e3e;
            padding: 15px;
            border-radius: 4px;
            margin: 15px;
        }

        .euaml-success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 15px;
            border-radius: 4px;
            margin: 15px;
        }

        .euaml-search-highlight {
            background-color: #fff3cd;
            padding: 0.1em 0.2em;
            border-radius: 0.2em;
            box-shadow: 0 0 0 1px #ffeeba;
        }

        .euaml-close-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            user-select: none;
        }

        .euaml-close-btn:hover {
            background: #e9ecef;
        }

        .law-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .law-badge.eu-aml {
            background: #063AA8;
            color: white;
        }

        .law-badge.gdpr {
            background: #8B5CF6;
            color: white;
        }

        .law-badge.ai-act {
            background: #059669;
            color: white;
        }

        .law-badge.dsa {
            background: #DC2626;
            color: white;
        }

        /* Deutsche Gesetze Badges */
        .law-badge.de-gwg {
            background: #B91C1C;
            color: white;
        }

        .law-badge.de-kwg {
            background: #1F2937;
            color: white;
        }

        .law-badge.de-zag {
            background: #7C3AED;
            color: white;
        }

        .law-badge.de-awg {
            background: #EA580C;
            color: white;
        }

        .law-badge.de-awv {
            background: #F59E0B;
            color: white;
        }

        .law-badge.de-stgb {
            background: #991B1B;
            color: white;
        }

        .law-badge.de-vag {
            background: #0891B2;
            color: white;
        }

        .law-badge.de-kagb {
            background: #059669;
            color: white;
        }

        .law-badge.de-wphg {
            background: #0D9488;
            color: white;
        }

        .law-badge.de-sanktdg {
            background: #DC2626;
            color: white;
        }

        .law-badge.default {
            background: #6B7280;
            color: white;
        }

        @media (max-width: 768px) {
            .euaml-container {
                margin: 10px;
                border-radius: 4px;
                height: 95vh;
            }
            
            .euaml-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .euaml-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .euaml-law-selector {
                min-width: unset;
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="euaml-container" id="euamlContainer">
        <div class="euaml-header">
            <h1 class="euaml-title">
                üá™üá∫ EU-Gesetzes Navigator
                <span class="euaml-auto-badge">GitHub Auto-Update</span>
            </h1>
            <div class="euaml-controls">
                <select class="euaml-law-selector" id="euamlLawSelector">
                    <optgroup label="üá™üá∫ EU-Verordnungen">
                        <option value="eu_aml_2024">EU-Geldw√§scheverordnung 2024</option>
                        <option value="eu_gdpr_2016">EU-Datenschutz-Grundverordnung (GDPR)</option>
                        <option value="eu_ai_act_2024">EU-KI-Verordnung (AI Act) 2024</option>
                        <option value="eu_dsa_2022">Digital Services Act 2022</option>
                    </optgroup>
                    <optgroup label="üè¶ Deutsche Gesetze - Geldw√§schepr√§vention">
                        <option value="de_gwg_2017">Geldw√§schegesetz (GwG)</option>
                        <option value="de_kwg">Kreditwesengesetz (KWG)</option>
                        <option value="de_zag_2018">Zahlungsdiensteaufsichtsgesetz (ZAG)</option>
                        <option value="de_vag_2016">Versicherungsaufsichtsgesetz (VAG)</option>
                    </optgroup>
                    <optgroup label="üåç Deutsche Gesetze - Sanktionen & Au√üenwirtschaft">
                        <option value="de_awg">Au√üenwirtschaftsgesetz (AWG)</option>
                        <option value="de_awv_2013">Au√üenwirtschaftsverordnung (AWV)</option>
                        <option value="de_eu_sanktdg">EU-Sanktions-Durchf√ºhrungsgesetz</option>
                    </optgroup>
                    <optgroup label="üìà Deutsche Gesetze - Kapitalmarkt & Investitionen">
                        <option value="de_kagb">Kapitalanlagegesetzbuch (KAGB)</option>
                        <option value="de_wphg">Wertpapierhandelsgesetz (WpHG)</option>
                    </optgroup>
                    <optgroup label="‚öñÔ∏è Deutsche Gesetze - Strafrecht">
                        <option value="de_stgb">Strafgesetzbuch (StGB) - ¬ß261 Geldw√§sche</option>
                    </optgroup>
                </select>
                <button class="euaml-refresh-btn" id="euamlRefreshBtn">üîÑ Neu laden</button>
            </div>
        </div>
        <div class="euaml-content" id="euamlContent">
            <div class="euaml-info-banner">
                <span>ü§ñ</span>
                <span>
                    <strong>T√§glich automatisch aktualisiert</strong> um 6:00 Uhr | 
                    EU-Verordnungen: zuverl√§ssig | Deutsche Gesetze: best-effort via 
                    <a href="#" class="euaml-github-link" id="githubLink" target="_blank">GitHub Actions</a>
                </span>
            </div>
            <div class="euaml-search-section">
                <input type="text" class="euaml-search-input" id="euamlSearchInput" 
                       placeholder="Suche nach Artikeln oder Begriffen... (z.B. 'Art. 1', 'Begriffsbestimmungen')">
            </div>
            <div class="euaml-main-content" id="euamlMainContent">
                <div class="euaml-loading">
                    <div class="euaml-loading-spinner"></div>
                    <span>Lade automatisch aktualisierte EU-Verordnung...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            console.log('EU-Gesetzes Navigator mit GitHub Auto-Updates startet...');
            
            // Konfiguration - ANPASSEN AN IHR REPOSITORY!
            const GITHUB_CONFIG = {
                username: 'IHR-GITHUB-USERNAME',  // ‚ö†Ô∏è HIER ANPASSEN
                repository: 'IHR-REPOSITORY-NAME', // ‚ö†Ô∏è HIER ANPASSEN  
                branch: 'main'
            };
            
            // Konfiguration der verf√ºgbaren Gesetze
            const AVAILABLE_LAWS = {
                // EU-Verordnungen
                'eu_aml_2024': {
                    name: 'EU-Geldw√§scheverordnung 2024',
                    shortName: 'EU-GwVO',
                    filename: 'eu-aml-2024.html',
                    celex: '32024R1624',
                    type: 'eu-regulation',
                    color: '#063AA8'
                },
                'eu_gdpr_2016': {
                    name: 'EU-Datenschutz-Grundverordnung',
                    shortName: 'GDPR',
                    filename: 'eu-gdpr-2016.html',
                    celex: '32016R0679',
                    type: 'eu-regulation',
                    color: '#8B5CF6'
                },
                'eu_ai_act_2024': {
                    name: 'EU-KI-Verordnung (AI Act)',
                    shortName: 'AI Act',
                    filename: 'eu-ai-act-2024.html',
                    celex: '32024R1689',
                    type: 'eu-regulation',
                    color: '#059669'
                },
                'eu_dsa_2022': {
                    name: 'Digital Services Act',
                    shortName: 'DSA',
                    filename: 'eu-dsa-2022.html',
                    celex: '32022R2065',
                    type: 'eu-regulation',
                    color: '#DC2626'
                },
                
                // Deutsche Gesetze - Geldw√§schepr√§vention & Sanktionen
                'de_gwg_2017': {
                    name: 'Geldw√§schegesetz (GwG)',
                    shortName: 'GwG',
                    filename: 'de-gwg-2017.html',
                    type: 'german-law',
                    category: 'aml',
                    color: '#B91C1C'
                },
                'de_kwg': {
                    name: 'Kreditwesengesetz (KWG)',
                    shortName: 'KWG',
                    filename: 'de-kwg.html',
                    type: 'german-law',
                    category: 'banking',
                    color: '#1F2937'
                },
                'de_zag_2018': {
                    name: 'Zahlungsdiensteaufsichtsgesetz (ZAG)',
                    shortName: 'ZAG',
                    filename: 'de-zag-2018.html',
                    type: 'german-law',
                    category: 'payments',
                    color: '#7C3AED'
                },
                'de_awg': {
                    name: 'Au√üenwirtschaftsgesetz (AWG)',
                    shortName: 'AWG',
                    filename: 'de-awg.html',
                    type: 'german-law',
                    category: 'sanctions',
                    color: '#EA580C'
                },
                'de_awv_2013': {
                    name: 'Au√üenwirtschaftsverordnung (AWV)',
                    shortName: 'AWV',
                    filename: 'de-awv-2013.html',
                    type: 'german-law',
                    category: 'sanctions',
                    color: '#F59E0B'
                },
                'de_stgb': {
                    name: 'Strafgesetzbuch (StGB)',
                    shortName: 'StGB',
                    filename: 'de-stgb.html',
                    type: 'german-law',
                    category: 'criminal',
                    color: '#991B1B'
                },
                'de_vag_2016': {
                    name: 'Versicherungsaufsichtsgesetz (VAG)',
                    shortName: 'VAG',
                    filename: 'de-vag-2016.html',
                    type: 'german-law',
                    category: 'insurance',
                    color: '#0891B2'
                },
                'de_kagb': {
                    name: 'Kapitalanlagegesetzbuch (KAGB)',
                    shortName: 'KAGB',
                    filename: 'de-kagb.html',
                    type: 'german-law',
                    category: 'investments',
                    color: '#059669'
                },
                'de_wphg': {
                    name: 'Wertpapierhandelsgesetz (WpHG)',
                    shortName: 'WpHG',
                    filename: 'de-wphg.html',
                    type: 'german-law',
                    category: 'securities',
                    color: '#0D9488'
                },
                'de_eu_sanktdg': {
                    name: 'EU-Sanktions-Durchf√ºhrungsgesetz',
                    shortName: 'EU-SanktDG',
                    filename: 'de-eu-sanktdg.html',
                    type: 'german-law',
                    category: 'sanctions',
                    color: '#DC2626'
                }
            };
            
            var currentLaw = 'eu_aml_2024'; // Starte mit EU-Gesetz (zuverl√§ssiger)
            var sections = [];
            var articleContents = new Map();
            var searchTimeout = null;
            var lastUpdateTime = null;
            
            var container = null;
            var content = null;
            var searchInput = null;
            var mainContent = null;
            var lawSelector = null;
            var refreshBtn = null;
            var githubLink = null;
            
            function initElements() {
                container = document.getElementById('euamlContainer');
                content = document.getElementById('euamlContent');
                searchInput = document.getElementById('euamlSearchInput');
                mainContent = document.getElementById('euamlMainContent');
                lawSelector = document.getElementById('euamlLawSelector');
                refreshBtn = document.getElementById('euamlRefreshBtn');
                githubLink = document.getElementById('githubLink');
                
                // GitHub-Link setzen
                if (githubLink) {
                    githubLink.href = `https://github.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/tree/${GITHUB_CONFIG.branch}/laws`;
                }

                if (!container || !content || !searchInput || !mainContent || !lawSelector) {
                    console.error('Konnte nicht alle DOM-Elemente finden');
                    return false;
                }
                return true;
            }
            
            function showError(message) {
                if (mainContent) {
                    mainContent.innerHTML = 
                        '<div class="euaml-error">' +
                        '<strong>Fehler:</strong><br>' + message +
                        '<br><br>' +
                        'üí° <strong>Tipp:</strong> Pr√ºfen Sie die GitHub-Repository-Konfiguration in der HTML-Datei.' +
                        '</div>';
                }
            }
            
            function showSuccess(message) {
                if (mainContent) {
                    var notification = document.createElement('div');
                    notification.className = 'euaml-success';
                    notification.innerHTML = message;
                    mainContent.insertBefore(notification, mainContent.firstChild);
                    
                    setTimeout(function() {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                }
            }
            
            function getGitHubRawUrl(filename) {
                return `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/${GITHUB_CONFIG.branch}/laws/${filename}`;
            }
            
            async function loadUpdateMetadata() {
                try {
                    const metadataUrl = getGitHubRawUrl('last-update.json');
                    console.log('Lade Update-Metadaten von:', metadataUrl);
                    
                    const response = await fetch(metadataUrl + '?t=' + Date.now()); // Cache-Buster
                    
                    if (!response.ok) {
                        throw new Error(`Metadaten nicht verf√ºgbar: ${response.status}`);
                    }
                    
                    const metadata = await response.json();
                    lastUpdateTime = new Date(metadata.last_update);
                    
                    console.log('‚úÖ Metadaten geladen - Letztes Update:', lastUpdateTime.toLocaleString('de-DE'));
                    
                    // Analyse der verf√ºgbaren Gesetze
                    let euCount = 0;
                    let deCount = 0;
                    let deTotal = 0;
                    
                    for (const [key, law] of Object.entries(metadata.laws || {})) {
                        if (law.type === 'eu-regulation') {
                            euCount++;
                        } else if (law.type === 'german-law') {
                            deTotal++;
                            if (law.size > 5000) { // Gr√∂√üer als Fallback
                                deCount++;
                            }
                        }
                    }
                    
                    // Zeige Status in der Info-Banner
                    updateAvailabilityStatus(euCount, deCount, deTotal);
                    
                    return metadata;
                    
                } catch (error) {
                    console.warn('Metadaten konnten nicht geladen werden:', error);
                    return null;
                }
            }
            
            function updateAvailabilityStatus(euCount, deCount, deTotal) {
                const banner = document.querySelector('.euaml-info-banner span:last-child');
                if (banner && deTotal > 0) {
                    const deStatus = deCount === deTotal ? 'alle verf√ºgbar' : 
                                   deCount === 0 ? 'Fallbacks verwendet' : 
                                   `${deCount}/${deTotal} verf√ºgbar`;
                    
                    banner.innerHTML = `
                        <strong>T√§glich automatisch aktualisiert</strong> um 6:00 Uhr | 
                        EU-Verordnungen: ${euCount}/4 ‚úÖ | Deutsche Gesetze: ${deStatus} | 
                        <a href="#" class="euaml-github-link" id="githubLink" target="_blank">GitHub Actions</a>
                    `;
                    
                    // GitHub-Link neu setzen
                    const newGithubLink = document.getElementById('githubLink');
                    if (newGithubLink) {
                        newGithubLink.href = `https://github.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/tree/${GITHUB_CONFIG.branch}/laws`;
                    }
                }
            }
            
            async function loadFromGitHub(lawConfig) {
                console.log('Lade von GitHub:', lawConfig.name);
                
                if (mainContent) {
                    mainContent.innerHTML = 
                        '<div class="euaml-loading">' +
                        '<div class="euaml-loading-spinner"></div>' +
                        '<span>Lade ' + lawConfig.name + ' von GitHub...</span>' +
                        '</div>';
                }
                
                try {
                    // Lade zuerst Metadaten
                    await loadUpdateMetadata();
                    
                    const fileUrl = getGitHubRawUrl(lawConfig.filename);
                    console.log('Lade Gesetz von:', fileUrl);
                    
                    const response = await fetch(fileUrl + '?t=' + Date.now(), {
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const html = await response.text();
                    
                    if (!html || html.length < 1000) {
                        throw new Error('Datei zu kurz oder leer');
                    }
                    
                    console.log(lawConfig.name + ' erfolgreich geladen:', html.length, 'Zeichen');
                    parseContent(html, lawConfig);
                    
                    const updateInfo = lastUpdateTime ? 
                        ` (Letztes Update: ${lastUpdateTime.toLocaleString('de-DE')})` : '';
                    showSuccess(`‚úÖ ${lawConfig.name} erfolgreich geladen!${updateInfo}`);
                    
                } catch (error) {
                    console.error('GitHub-Fehler:', error);
                    showError(`Fehler beim Laden von ${lawConfig.name}: ${error.message}<br><br>` +
                        `Pr√ºfen Sie: <br>` +
                        `‚Ä¢ Repository: ${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}<br>` +
                        `‚Ä¢ Datei: laws/${lawConfig.filename}<br>` +
                        `‚Ä¢ GitHub Actions Workflow aktiv?`);
                    loadFallback(lawConfig);
                }
            }
            
            function loadFallback(lawConfig) {
                console.log('Lade Fallback-Content f√ºr:', lawConfig.name);
                
                if (lawConfig.shortName === 'GDPR') {
                    sections = createGDPRFallback();
                } else if (lawConfig.shortName === 'AI Act') {
                    sections = createAIActFallback();
                } else if (lawConfig.shortName === 'DSA') {
                    sections = createDSAFallback();
                } else {
                    sections = createAMLFallback();
                }
                
                renderSections();
            }
            
            function createGDPRFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand und Ziele", id: "art_1" },
                        { number: 2, title: "Sachlicher Anwendungsbereich", id: "art_2" },
                        { number: 3, title: "R√§umlicher Anwendungsbereich", id: "art_3" },
                        { number: 4, title: "Begriffsbestimmungen", id: "art_4" }
                    ]
                }, {
                    number: 2,
                    title: "Grunds√§tze",
                    articles: [
                        { number: 5, title: "Grunds√§tze f√ºr die Verarbeitung personenbezogener Daten", id: "art_5" },
                        { number: 6, title: "Rechtm√§√üigkeit der Verarbeitung", id: "art_6" }
                    ]
                }];
            }
            
            function createAMLFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand", id: "art_1" },
                        { number: 2, title: "Begriffsbestimmungen", id: "art_2" },
                        { number: 3, title: "Anwendungsbereich", id: "art_3" }
                    ]
                }];
            }
            
            function createAIActFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand und Anwendungsbereich", id: "art_1" },
                        { number: 3, title: "Begriffsbestimmungen", id: "art_3" },
                        { number: 4, title: "√Ñnderungen von Anh√§ngen", id: "art_4" }
                    ]
                }];
            }
            
            function createDSAFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand und Anwendungsbereich", id: "art_1" },
                        { number: 2, title: "Begriffsbestimmungen", id: "art_2" },
                        { number: 3, title: "Anwendungsbereich", id: "art_3" }
                    ]
                }];
            }
            
            function parseContent(html, lawConfig) {
                try {
                    console.log('Parse HTML Content f√ºr:', lawConfig.name);
                    
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    sections = parseArticleStructure(tempDiv, lawConfig);
                    extractArticleContents(tempDiv, lawConfig);
                    renderSections();
                    console.log('Parsing erfolgreich:', sections.length, 'Abschnitte');
                    
                } catch (error) {
                    console.error('Parse-Fehler:', error);
                    loadFallback(lawConfig);
                }
            }
            
            function parseArticleStructure(tempDiv, lawConfig) {
                // Unterscheide zwischen EU-Verordnungen und deutschen Gesetzen
                if (lawConfig.type === 'eu-regulation') {
                    return parseEURegulationStructure(tempDiv, lawConfig);
                } else if (lawConfig.type === 'german-law') {
                    return parseGermanLawStructure(tempDiv, lawConfig);
                }
                
                throw new Error('Unbekannter Gesetzestyp: ' + lawConfig.type);
            }
            
            function parseEURegulationStructure(tempDiv, lawConfig) {
                // Suche nach Artikel-Elementen
                var selectors = [
                    '[id^="art_"]',
                    '[id^="article_"]',
                    '[id^="Art"]',
                    '[id*="article"]'
                ];
                
                var articleElements = [];
                for (var s = 0; s < selectors.length; s++) {
                    var found = tempDiv.querySelectorAll(selectors[s]);
                    if (found.length > 0) {
                        console.log(`EU-Regulation - Gefunden mit Selector "${selectors[s]}":`, found.length, 'Artikel');
                        articleElements = found;
                        break;
                    }
                }
                
                if (articleElements.length > 0) {
                    return createSectionsFromElements(articleElements, lawConfig);
                }
                
                // Fallback: Links
                var articleLinks = tempDiv.querySelectorAll('a[href^="#art"], a[href*="article"]');
                if (articleLinks.length > 0) {
                    console.log('EU-Regulation - Gefunden √ºber Links:', articleLinks.length, 'Artikel');
                    return createSectionsFromLinks(articleLinks, lawConfig);
                }
                
                throw new Error('Keine EU-Artikel gefunden');
            }
            
            function parseGermanLawStructure(tempDiv, lawConfig) {
                console.log('Parse deutsche Gesetze-Struktur f√ºr:', lawConfig.shortName);
                
                // Deutsche Gesetze verwenden Paragraphen (¬ß) statt Artikel
                var selectors = [
                    '[id^="para"]',           // ¬ß1, ¬ß2, etc.
                    '[id^="P"]',              // P1, P2, etc.
                    '[id*="paragraph"]',      // paragraph1, etc.
                    'div.jurAbsatz',          // Typische Struktur von gesetze-im-internet.de
                    '.norm'                   // Norm-Container
                ];
                
                var paragraphElements = [];
                for (var s = 0; s < selectors.length; s++) {
                    var found = tempDiv.querySelectorAll(selectors[s]);
                    if (found.length > 0) {
                        console.log(`Deutsche Gesetze - Gefunden mit Selector "${selectors[s]}":`, found.length, 'Paragraphen');
                        paragraphElements = found;
                        break;
                    }
                }
                
                // Fallback: Suche nach Links zu Paragraphen
                if (paragraphElements.length === 0) {
                    var paragraphLinks = tempDiv.querySelectorAll('a[href*="para"], a[href*="P"], a[href*="BJNR"]');
                    console.log('Deutsche Gesetze - Links gefunden:', paragraphLinks.length);
                    
                    if (paragraphLinks.length > 0) {
                        return createGermanSectionsFromLinks(paragraphLinks, lawConfig);
                    }
                }
                
                if (paragraphElements.length > 0) {
                    return createGermanSectionsFromElements(paragraphElements, lawConfig);
                }
                
                throw new Error('Keine deutschen Paragraphen gefunden');
            }
            
            function createGermanSectionsFromElements(elements, lawConfig) {
                var allParagraphs = [];
                var processedIds = new Set();
                
                for (var i = 0; i < elements.length; i++) {
                    var element = elements[i];
                    
                    if (processedIds.has(element.id)) continue;
                    processedIds.add(element.id);
                    
                    // Verschiedene Muster f√ºr deutsche Paragraph-IDs
                    var patterns = [
                        /para(\d+)/i,           // para1, para2
                        /P(\d+)/,               // P1, P2
                        /paragraph(\d+)/i,      // paragraph1
                        /(\d+)/                 // Fallback: nur Zahlen
                    ];
                    
                    var paragraphNum = null;
                    for (var p = 0; p < patterns.length; p++) {
                        var match = element.id.match(patterns[p]);
                        if (match) {
                            paragraphNum = parseInt(match[1], 10);
                            if (paragraphNum > 0 && paragraphNum < 10000) {
                                break;
                            }
                        }
                    }
                    
                    if (paragraphNum) {
                        var title = extractGermanTitle(element, paragraphNum);
                        
                        allParagraphs.push({
                            number: paragraphNum,
                            title: title,
                            id: element.id,
                            isParagraph: true  // Kennzeichnung f√ºr deutsche Paragraphen
                        });
                        
                        console.log(`¬ß ${paragraphNum}: ${title}`);
                    }
                }
                
                allParagraphs.sort(function(a, b) { return a.number - b.number; });
                return groupGermanParagraphs(allParagraphs, lawConfig);
            }
            
            function createGermanSectionsFromLinks(paragraphLinks, lawConfig) {
                var allParagraphs = [];
                var processedNumbers = new Set();
                
                for (var i = 0; i < paragraphLinks.length; i++) {
                    var link = paragraphLinks[i];
                    var href = link.getAttribute('href') || '';
                    var text = link.textContent || '';
                    
                    // Extrahiere Paragraph-Nummer aus Link
                    var patterns = [
                        /¬ß\s*(\d+)/,           // ¬ß 1, ¬ß2
                        /para(\d+)/i,          // para1
                        /P(\d+)/,              // P1
                        /(\d+)/                // Fallback
                    ];
                    
                    var paragraphNum = null;
                    for (var p = 0; p < patterns.length; p++) {
                        var match = (href + ' ' + text).match(patterns[p]);
                        if (match) {
                            paragraphNum = parseInt(match[1], 10);
                            if (paragraphNum > 0 && paragraphNum < 10000 && !processedNumbers.has(paragraphNum)) {
                                break;
                            }
                        }
                    }
                    
                    if (paragraphNum && !processedNumbers.has(paragraphNum)) {
                        processedNumbers.add(paragraphNum);
                        var title = extractGermanTitle(link, paragraphNum);
                        
                        allParagraphs.push({
                            number: paragraphNum,
                            title: title,
                            id: 'para_' + paragraphNum,
                            isParagraph: true
                        });
                    }
                }
                
                allParagraphs.sort(function(a, b) { return a.number - b.number; });
                return groupGermanParagraphs(allParagraphs, lawConfig);
            }
            
            function extractGermanTitle(element, paragraphNum) {
                // Deutsche Gesetzestitel extrahieren
                var selectors = [
                    '.titel',               // Typisch f√ºr gesetze-im-internet.de
                    '.√ºberschrift',
                    '.heading',
                    'h1', 'h2', 'h3', 'h4',
                    'strong:first-child',
                    'b:first-child'
                ];
                
                for (var s = 0; s < selectors.length; s++) {
                    var titleEl = element.querySelector ? element.querySelector(selectors[s]) : null;
                    if (!titleEl && element.textContent) {
                        var text = element.textContent.trim();
                        if (text.length > 3 && text.length < 200) {
                            return text.replace(/^¬ß\s*\d+\s*[-‚Äì]?\s*/i, '');
                        }
                    }
                    
                    if (titleEl) {
                        var text = titleEl.textContent.trim();
                        if (text.length > 2 && text.length < 200) {
                            return text.replace(/^¬ß\s*\d+\s*[-‚Äì]?\s*/i, '');
                        }
                    }
                }
                
                return '¬ß ' + paragraphNum;
            }
            
            function groupGermanParagraphs(allParagraphs, lawConfig) {
                // Gesetzspezifische Gruppierung f√ºr deutsche Gesetze
                switch (lawConfig.shortName) {
                    case 'GwG':
                        return groupGwGParagraphs(allParagraphs);
                    case 'KWG':
                        return groupKWGParagraphs(allParagraphs);
                    case 'ZAG':
                        return groupZAGParagraphs(allParagraphs);
                    case 'AWG':
                        return groupAWGParagraphs(allParagraphs);
                    case 'AWV':
                        return groupAWVParagraphs(allParagraphs);
                    case 'StGB':
                        return groupStGBParagraphs(allParagraphs);
                    case 'VAG':
                        return groupVAGParagraphs(allParagraphs);
                    case 'KAGB':
                        return groupKAGBParagraphs(allParagraphs);
                    case 'WpHG':
                        return groupWpHGParagraphs(allParagraphs);
                    case 'EU-SanktDG':
                        return groupEUSanktDGParagraphs(allParagraphs);
                    default:
                        return groupGenericGermanParagraphs(allParagraphs);
                }
            }
            
            function groupGwGParagraphs(allParagraphs) {
                var sections = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 3 },
                    { title: "Sorgfaltspflichten", start: 4, end: 11 },
                    { title: "Organisationspflichten", start: 12, end: 25 },
                    { title: "Meldepflichten", start: 26, end: 45 },
                    { title: "Aufsicht", start: 46, end: 55 },
                    { title: "Bu√ügeld- und Strafvorschriften", start: 56, end: 65 }
                ];
                
                return createGermanSectionsFromRanges(sections, allParagraphs);
            }
            
            function groupKWGParagraphs(allParagraphs) {
                var sections = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 11 },
                    { title: "Bankgesch√§fte", start: 12, end: 25 },
                    { title: "Aufsicht √ºber Institute", start: 26, end: 45 },
                    { title: "Eigenmittel und Liquidit√§t", start: 46, end: 65 },
                    { title: "Sanktionen", start: 66, end: 75 }
                ];
                
                return createGermanSectionsFromRanges(sections, allParagraphs);
            }
            
            function groupZAGParagraphs(allParagraphs) {
                var sections = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 5 },
                    { title: "Erlaubnis", start: 6, end: 15 },
                    { title: "Aufsicht", start: 16, end: 25 },
                    { title: "Sonstige Bestimmungen", start: 26, end: 35 }
                ];
                
                return createGermanSectionsFromRanges(sections, allParagraphs);
            }
            
            function groupAWGParagraphs(allParagraphs) {
                var sections = [
                    { title: "Grundlagen", start: 1, end: 5 },
                    { title: "Beschr√§nkungen", start: 6, end: 15 },
                    { title: "Durchf√ºhrung", start: 16, end: 25 },
                    { title: "Sanktionen", start: 26, end: 35 }
                ];
                
                return createGermanSectionsFromRanges(sections, allParagraphs);
            }
            
            function groupStGBParagraphs(allParagraphs) {
                // Fokus auf Geldw√§sche-relevante Paragraphen
                var sections = [
                    { title: "Geldw√§sche und Terrorismusfinanzierung", start: 260, end: 265 },
                    { title: "Weitere relevante Straftaten", start: 266, end: 280 }
                ];
                
                return createGermanSectionsFromRanges(sections, allParagraphs);
            }
            
            function groupGenericGermanParagraphs(allParagraphs) {
                // Generische Gruppierung f√ºr unbekannte deutsche Gesetze
                var sectionsSize = 20; // Gruppiere in 20er-Bl√∂cke
                var sections = [];
                var currentSection = 1;
                
                for (var i = 0; i < allParagraphs.length; i += sectionsSize) {
                    var sectionParagraphs = allParagraphs.slice(i, i + sectionsSize);
                    if (sectionParagraphs.length > 0) {
                        var startNum = sectionParagraphs[0].number;
                        var endNum = sectionParagraphs[sectionParagraphs.length - 1].number;
                        
                        sections.push({
                            number: currentSection++,
                            title: `¬ß¬ß ${startNum}-${endNum}`,
                            articles: sectionParagraphs
                        });
                    }
                }
                
                return sections;
            }
            
            function createGermanSectionsFromRanges(ranges, allParagraphs) {
                var result = [];
                
                for (var i = 0; i < ranges.length; i++) {
                    var range = ranges[i];
                    var sectionParagraphs = [];
                    
                    for (var j = 0; j < allParagraphs.length; j++) {
                        var paragraph = allParagraphs[j];
                        if (paragraph.number >= range.start && paragraph.number <= range.end) {
                            sectionParagraphs.push(paragraph);
                        }
                    }
                    
                    if (sectionParagraphs.length > 0) {
                        result.push({
                            number: i + 1,
                            title: range.title,
                            articles: sectionParagraphs  // Verwende "articles" f√ºr Kompatibilit√§t
                        });
                    }
                }
                
                return result;
            }
            
            // Restliche Gruppierungsfunktionen - minimale Implementierung
            function groupAWVParagraphs(allParagraphs) { return groupGenericGermanParagraphs(allParagraphs); }
            function groupVAGParagraphs(allParagraphs) { return groupGenericGermanParagraphs(allParagraphs); }
            function groupKAGBParagraphs(allParagraphs) { return groupGenericGermanParagraphs(allParagraphs); }
            function groupWpHGParagraphs(allParagraphs) { return groupGenericGermanParagraphs(allParagraphs); }
            function groupEUSanktDGParagraphs(allParagraphs) { return groupGenericGermanParagraphs(allParagraphs); }
            
            function createSectionsFromElements(elements, lawConfig) {
                var allArticles = [];
                var processedIds = new Set();
                
                for (var i = 0; i < elements.length; i++) {
                    var element = elements[i];
                    
                    if (processedIds.has(element.id)) continue;
                    processedIds.add(element.id);
                    
                    var match = element.id.match(/art[icle]*[_-]?(\d+)/i);
                    if (match) {
                        var num = parseInt(match[1], 10);
                        if (num > 0 && num < 1000) {
                            var title = extractTitle(element, num);
                            
                            allArticles.push({
                                number: num,
                                title: title,
                                id: element.id
                            });
                            
                            console.log(`Artikel ${num}: ${title}`);
                        }
                    }
                }
                
                allArticles.sort(function(a, b) { return a.number - b.number; });
                return groupArticles(allArticles, lawConfig);
            }
            
            function createSectionsFromLinks(articleLinks, lawConfig) {
                var allArticles = [];
                var processedNumbers = new Set();
                
                for (var i = 0; i < articleLinks.length; i++) {
                    var link = articleLinks[i];
                    var href = link.getAttribute('href');
                    var match = href.match(/#art[icle]*[_-]?(\d+)/i);
                    
                    if (match) {
                        var num = parseInt(match[1], 10);
                        
                        if (processedNumbers.has(num)) continue;
                        processedNumbers.add(num);
                        
                        var title = extractTitle(link, num);
                        
                        allArticles.push({
                            number: num,
                            title: title,
                            id: 'art_' + num
                        });
                    }
                }
                
                allArticles.sort(function(a, b) { return a.number - b.number; });
                return groupArticles(allArticles, lawConfig);
            }
            
            function extractTitle(element, articleNum) {
                var selectors = ['.oj-sti-art', '.eli-title', '.title', 'h1', 'h2', 'h3', 'strong', 'b'];
                
                for (var s = 0; s < selectors.length; s++) {
                    var titleEl = element.querySelector ? element.querySelector(selectors[s]) : null;
                    if (!titleEl && element.textContent) {
                        var text = element.textContent.trim();
                        if (text.length > 3 && text.length < 200) {
                            return text.replace(/^Artikel\s+\d+\s*[-‚Äì]?\s*/i, '');
                        }
                    }
                    
                    if (titleEl) {
                        var text = titleEl.textContent.trim();
                        if (text.length > 2 && text.length < 200) {
                            return text.replace(/^Artikel\s+\d+\s*[-‚Äì]?\s*/i, '');
                        }
                    }
                }
                
                return 'Artikel ' + articleNum;
            }
            
            function groupArticles(allArticles, lawConfig) {
                switch (lawConfig.shortName) {
                    case 'GDPR':
                        return groupGDPRArticles(allArticles);
                    case 'AI Act':
                        return groupAIActArticles(allArticles);
                    case 'DSA':
                        return groupDSAArticles(allArticles);
                    default:
                        return groupAMLArticles(allArticles);
                }
            }
            
            function groupGDPRArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 4 },
                    { title: "Grunds√§tze", start: 5, end: 11 },
                    { title: "Rechte der betroffenen Person", start: 12, end: 23 },
                    { title: "Verantwortlicher und Auftragsverarbeiter", start: 24, end: 43 },
                    { title: "√úbermittlung an Drittl√§nder", start: 44, end: 50 },
                    { title: "Unabh√§ngige Aufsichtsbeh√∂rden", start: 51, end: 76 },
                    { title: "Zusammenarbeit und Koh√§renz", start: 77, end: 84 },
                    { title: "Rechtsbehelfe und Sanktionen", start: 85, end: 91 },
                    { title: "Schlussbestimmungen", start: 92, end: 99 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function groupAMLArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 8 },
                    { title: "Interne Strategien, Verfahren und Kontrollen", start: 9, end: 18 },
                    { title: "Sorgfaltspr√ºfung in Bezug auf Kunden", start: 19, end: 50 },
                    { title: "Transparenz des wirtschaftlichen Eigentums", start: 51, end: 68 },
                    { title: "Meldepflichten", start: 69, end: 75 },
                    { title: "Schlussbestimmungen", start: 76, end: 95 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function groupAIActArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 12 },
                    { title: "Verbotene KI-Praktiken", start: 13, end: 15 },
                    { title: "Hochrisiko-KI-Systeme", start: 16, end: 51 },
                    { title: "Transparenzpflichten", start: 52, end: 54 },
                    { title: "Governance und Umsetzung", start: 55, end: 78 },
                    { title: "Sanktionen", start: 79, end: 83 },
                    { title: "Schlussbestimmungen", start: 84, end: 113 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function groupDSAArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 6 },
                    { title: "Pflichten der Vermittlungsdienste", start: 7, end: 25 },
                    { title: "Online-Plattformen", start: 26, end: 39 },
                    { title: "Sehr gro√üe Online-Plattformen", start: 40, end: 68 },
                    { title: "Durchsetzung", start: 69, end: 87 },
                    { title: "Schlussbestimmungen", start: 88, end: 94 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function createSectionsFromRanges(ranges, allArticles) {
                var result = [];
                
                for (var i = 0; i < ranges.length; i++) {
                    var range = ranges[i];
                    var sectionArticles = [];
                    
                    for (var j = 0; j < allArticles.length; j++) {
                        var article = allArticles[j];
                        if (article.number >= range.start && article.number <= range.end) {
                            sectionArticles.push(article);
                        }
                    }
                    
                    if (sectionArticles.length > 0) {
                        result.push({
                            number: i + 1,
                            title: range.title,
                            articles: sectionArticles
                        });
                    }
                }
                
                return result;
            }
            
            function extractArticleContents(tempDiv, lawConfig) {
                var selectors;
                
                if (lawConfig.type === 'eu-regulation') {
                    selectors = [
                        '[id^="art_"]',
                        '[id^="article_"]', 
                        '[id^="Art"]',
                        '[id*="article"]'
                    ];
                } else if (lawConfig.type === 'german-law') {
                    selectors = [
                        '[id^="para"]',
                        '[id^="P"]',
                        '[id*="paragraph"]',
                        'div.jurAbsatz',
                        '.norm'
                    ];
                }
                
                var articleElements = [];
                for (var s = 0; s < selectors.length; s++) {
                    var found = tempDiv.querySelectorAll(selectors[s]);
                    if (found.length > 0) {
                        articleElements = found;
                        break;
                    }
                }
                
                console.log('Extrahiere Inhalte f√ºr', articleElements.length, lawConfig.type === 'german-law' ? 'Paragraphen' : 'Artikel');

                for (var i = 0; i < articleElements.length; i++) {
                    var article = articleElements[i];
                    var content = article.cloneNode(true);

                    // Bereinige Content
                    var unwanted = content.querySelectorAll('script, style, .nav, .navigation, .breadcrumb');
                    for (var u = 0; u < unwanted.length; u++) {
                        unwanted[u].remove();
                    }

                    // Entferne redundante Titel
                    var titleSelectors = ['.oj-sti-art', '.eli-title', '.title', 'h1', 'h2', 'h3', '.titel', '.√ºberschrift'];
                    for (var t = 0; t < titleSelectors.length; t++) {
                        var firstTitle = content.querySelector(titleSelectors[t]);
                        if (firstTitle && firstTitle.textContent.trim().length < 120) {
                            firstTitle.remove();
                            break;
                        }
                    }

                    if (lawConfig.type === 'eu-regulation') {
                        if (lawConfig.shortName === 'GDPR') {
                            formatGDPRContent(content);
                        } else {
                            formatEUContent(content);
                        }
                    } else if (lawConfig.type === 'german-law') {
                        // Pr√ºfe zuerst auf Fallback-Inhalt
                        if (!handleFallbackContent(content)) {
                            // Nur formatieren wenn es kein Fallback ist
                            formatGermanContent(content);
                        }
                    }

                    var cleanContent = content.innerHTML.trim();
                    if (cleanContent) {
                        articleContents.set(article.id, cleanContent);
                    }
                }

                console.log('Artikel-Inhalte extrahiert:', articleContents.size);
            }
            
            function formatGDPRContent(contentDiv) {
                var recitals = contentDiv.querySelectorAll('.recital, [class*="recital"]');
                for (var r = 0; r < recitals.length; r++) {
                    var recital = recitals[r];
                    recital.style.cssText = 'background: #fafafb; border-left: 3px solid #8B5CF6; margin: 1em 0; padding: 0.8em; font-style: italic; color: #4C1D95;';
                    
                    var text = recital.textContent;
                    var match = text.match(/\((\d+)\)/);
                    if (match) {
                        recital.innerHTML = recital.innerHTML.replace(
                            '(' + match[1] + ')',
                            '<span style="font-weight: 600; color: #8B5CF6;">(' + match[1] + ')</span>'
                        );
                    }
                }
                
                formatEUContent(contentDiv);
            }
            
            function formatEUContent(contentDiv) {
                // EU-Verordnungen Formatierung
                var tables = contentDiv.querySelectorAll('table');
                
                for (var i = 0; i < tables.length; i++) {
                    var table = tables[i];
                    var rows = table.querySelectorAll('tr');
                    var tableContent = '';
                    
                    for (var j = 0; j < rows.length; j++) {
                        var row = rows[j];
                        var cells = row.querySelectorAll('td');
                        if (cells.length >= 2) {
                            var marker = cells[0].textContent.trim();
                            var text = cells[1].textContent.trim();
                            
                            if (marker && text) {
                                tableContent += '<div style="margin: 0.5em 0; padding-left: 1.5em; position: relative;">';
                                tableContent += '<span style="position: absolute; left: 0; font-weight: 500; color: #063AA8;">' + marker + '</span>';
                                tableContent += text;
                                tableContent += '</div>';
                            }
                        }
                    }
                    
                    if (tableContent) {
                        var replacement = document.createElement('div');
                        replacement.innerHTML = tableContent;
                        table.parentNode.replaceChild(replacement, table);
                    }
                }
                
                var normalPs = contentDiv.querySelectorAll('p');
                for (var p = 0; p < normalPs.length; p++) {
                    var para = normalPs[p];
                    var text = para.textContent.trim();
                    
                    var match = text.match(/^\((\d+)\)\s+(.+)$/);
                    if (match) {
                        var absatzNum = match[1];
                        var absatzText = match[2];
                        
                        para.innerHTML = 
                            '<div style="margin: 0.5em 0; padding-left: 1.5em; position: relative;">' +
                            '<span style="position: absolute; left: 0; font-weight: 500; color: #063AA8;">(' + absatzNum + ')</span>' +
                            absatzText +
                            '</div>';
                    }
                }
                
                var articleTitles = contentDiv.querySelectorAll('.oj-ti-art, .title, h1, h2, h3');
                for (var t = 0; t < articleTitles.length; t++) {
                    var titleP = articleTitles[t];
                    titleP.style.cssText = 'font-weight: 600; color: #063AA8; margin: 1em 0 0.5em 0; font-size: 1.1em;';
                }
            }
            
            function formatGermanContent(contentDiv) {
                // Deutsche Gesetze-spezifische Formatierung
                console.log('Formatiere deutschen Gesetzesinhalt');
                
                // Formatiere Abs√§tze mit Nummern
                var paragraphs = contentDiv.querySelectorAll('p, .absatz, .jurAbsatz');
                for (var p = 0; p < paragraphs.length; p++) {
                    var para = paragraphs[p];
                    var text = para.textContent.trim();
                    
                    // Deutsche Abs√§tze: (1), (2), etc.
                    var match = text.match(/^\((\d+)\)\s+(.+)$/);
                    if (match) {
                        var absatzNum = match[1];
                        var absatzText = match[2];
                        
                        para.innerHTML = 
                            '<div style="margin: 0.5em 0; padding-left: 1.5em; position: relative;">' +
                            '<span style="position: absolute; left: 0; font-weight: 500; color: #B91C1C;">(' + absatzNum + ')</span>' +
                            absatzText +
                            '</div>';
                    }
                    
                    // Nummern: 1., 2., etc.
                    var numberMatch = text.match(/^(\d+)\.\s+(.+)$/);
                    if (numberMatch) {
                        var num = numberMatch[1];
                        var numText = numberMatch[2];
                        
                        para.innerHTML = 
                            '<div style="margin: 0.5em 0; padding-left: 1.5em; position: relative;">' +
                            '<span style="position: absolute; left: 0; font-weight: 500; color: #B91C1C;">' + num + '.</span>' +
                            numText +
                            '</div>';
                    }
                }
                
                // Formatiere Paragraph-Titel
                var titles = contentDiv.querySelectorAll('.titel, .√ºberschrift, h1, h2, h3, h4');
                for (var t = 0; t < titles.length; t++) {
                    var title = titles[t];
                    title.style.cssText = 'font-weight: 600; color: #B91C1C; margin: 1em 0 0.5em 0; font-size: 1.1em;';
                }
                
                // Formatiere Listen
                var lists = contentDiv.querySelectorAll('ol, ul');
                for (var l = 0; l < lists.length; l++) {
                    var list = lists[l];
                    list.style.cssText = 'margin: 0.5em 0; padding-left: 2em;';
                    
                    var listItems = list.querySelectorAll('li');
                    for (var li = 0; li < listItems.length; li++) {
                        var item = listItems[li];
                        item.style.cssText = 'margin: 0.3em 0;';
                    }
                }
                
                // Formatiere Tabellen
                var tables = contentDiv.querySelectorAll('table');
                for (var i = 0; i < tables.length; i++) {
                    var table = tables[i];
                    table.style.cssText = 'border-collapse: collapse; width: 100%; margin: 1em 0;';
                    
                    var rows = table.querySelectorAll('tr');
                    for (var j = 0; j < rows.length; j++) {
                        var row = rows[j];
                        var cells = row.querySelectorAll('td, th');
                        for (var c = 0; c < cells.length; c++) {
                            var cell = cells[c];
                            cell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: left;';
                        }
                    }
                }
            }
            
            function renderSections(filter) {
                if (!sections.length || !mainContent) return;
                
                var searchText = (filter || '').toLowerCase();
                var html = '';
                var hasResults = false;
                var lawConfig = AVAILABLE_LAWS[currentLaw];
                
                for (var i = 0; i < sections.length; i++) {
                    var section = sections[i];
                    var sectionHtml = '';
                    var sectionHasResults = false;
                    
                    for (var j = 0; j < section.articles.length; j++) {
                        var article = section.articles[j];
                        var searchableText = ('Art. ' + article.number + ' ' + article.title).toLowerCase();
                        var titleMatch = !searchText || searchableText.indexOf(searchText) !== -1;
                        var contentMatch = false;
                        
                        if (!titleMatch && searchText) {
                            var content = articleContents.get(article.id);
                            if (content) {
                                var contentText = content.toLowerCase();
                                contentMatch = contentText.indexOf(searchText) !== -1;
                            }
                        }
                        
                        if (titleMatch || contentMatch) {
                            var highlightedTitle = searchText ? highlightText(article.title, searchText) : article.title;
                            var badgeClass = {
                                'GDPR': 'gdpr',
                                'AI Act': 'ai-act',
                                'DSA': 'dsa'
                            }[lawConfig.shortName] || 'eu-aml';
                            
                            sectionHtml += '<div class="euaml-article' + (contentMatch ? ' euaml-content-match' : '') + '" data-article-id="' + article.id + '">';
                            sectionHtml += '<div class="euaml-article-title">';
                            sectionHtml += '<span>Art. ' + article.number + ' - ' + highlightedTitle + '</span>';
                            sectionHtml += '<div class="euaml-article-meta">';
                            sectionHtml += '<span class="law-badge ' + badgeClass + '">' + lawConfig.shortName + '</span>';
                            if (contentMatch) {
                                sectionHtml += '<span style="font-size: 0.85em; color: #0056b3; margin-left: 0.5em; padding: 2px 6px; border-radius: 4px; background-color: #e6f3ff;">(Treffer im Inhalt)</span>';
                            }
                            sectionHtml += '</div>';
                            sectionHtml += '</div>';
                            sectionHtml += '<div class="euaml-article-content"></div>';
                            sectionHtml += '</div>';
                            sectionHasResults = true;
                        }
                    }
                    
                    if (sectionHasResults) {
                        hasResults = true;
                        html += '<div class="euaml-section">';
                        html += '<div class="euaml-section-title">Abschnitt ' + section.number + ': ' + section.title;
                        if (lastUpdateTime) {
                            html += '<span class="euaml-update-time">Update: ' + lastUpdateTime.toLocaleString('de-DE') + '</span>';
                        }
                        html += '</div>';
                        html += sectionHtml;
                        html += '</div>';
                    }
                }
                
                if (!hasResults && searchText) {
                    html = '<div style="text-align: center; padding: 40px; color: #666;">Keine Ergebnisse f√ºr "' + filter + '" gefunden.</div>';
                }
                
                mainContent.innerHTML = html;
                bindEvents();
                console.log('Sections gerendert mit Filter:', filter);
            }
            
            function getBadgeClass(shortName) {
                var badgeClasses = {
                    // EU-Verordnungen
                    'EU-GwVO': 'eu-aml',
                    'GDPR': 'gdpr', 
                    'AI Act': 'ai-act',
                    'DSA': 'dsa',
                    
                    // Deutsche Gesetze
                    'GwG': 'de-gwg',
                    'KWG': 'de-kwg',
                    'ZAG': 'de-zag',
                    'AWG': 'de-awg',
                    'AWV': 'de-awv',
                    'StGB': 'de-stgb',
                    'VAG': 'de-vag',
                    'KAGB': 'de-kagb',
                    'WpHG': 'de-wphg',
                    'EU-SanktDG': 'de-sanktdg'
                };
                
                return badgeClasses[shortName] || 'default';
            }
            
            function getSourceUrl(lawConfig, article) {
                if (lawConfig.type === 'eu-regulation' && lawConfig.celex) {
                    var articleRef = article.isParagraph ? 'para_' + article.number : 'art_' + article.number;
                    return 'https://eur-lex.europa.eu/legal-content/DE/TXT/?uri=CELEX:' + lawConfig.celex + '#' + articleRef;
                } else if (lawConfig.type === 'german-law') {
                    // Deutsche Gesetze - Link zu gesetze-im-internet.de
                    var lawMappings = {
                        'GwG': 'gwg_2017',
                        'KWG': 'kwg',
                        'ZAG': 'zag_2018',
                        'AWG': 'awg',
                        'AWV': 'awv_2013',
                        'StGB': 'stgb',
                        'VAG': 'vag_2016',
                        'KAGB': 'kagb',
                        'WpHG': 'wphg',
                        'EU-SanktDG': 'eusanktdg'
                    };
                    
                    var lawPath = lawMappings[lawConfig.shortName];
                    if (lawPath) {
                        return 'https://www.gesetze-im-internet.de/' + lawPath + '/';
                    }
                }
                
                return '#'; // Fallback
            }
            
            function highlightText(text, searchTerm) {
                if (!searchTerm || searchTerm.length < 1) return text;
                var escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\                return '#'; // Fallback
            }');
                var regex = new RegExp('(' + escapedTerm + ')', 'gi');
                return text.replace(regex, '<span class="euaml-search-highlight">$1</span>');
            }
            
            function bindEvents() {
                var articles = mainContent.querySelectorAll('.euaml-article');
                
                for (var i = 0; i < articles.length; i++) {
                    articles[i].addEventListener('click', function(e) {
                        var selection = window.getSelection();
                        if (selection && selection.toString().trim().length > 0) {
                            return;
                        }
                        
                        var contentDiv = this.querySelector('.euaml-article-content');
                        if (contentDiv && contentDiv.contains(e.target)) {
                            return;
                        }
                        
                        toggleArticle(this);
                    });
                }
            }
            
            function toggleArticle(articleElement) {
                var articleId = articleElement.getAttribute('data-article-id');
                var wasActive = articleElement.classList.contains('euaml-active');
                
                var allArticles = mainContent.querySelectorAll('.euaml-article');
                for (var i = 0; i < allArticles.length; i++) {
                    if (allArticles[i] !== articleElement) {
                        allArticles[i].classList.remove('euaml-active');
                    }
                }
                
                if (wasActive) {
                    articleElement.classList.remove('euaml-active');
                    return;
                }
                
                articleElement.classList.add('euaml-active');
                loadArticleContent(articleElement, articleId);
            }
            
            function loadArticleContent(articleElement, articleId) {
                var contentDiv = articleElement.querySelector('.euaml-article-content');
                var content = articleContents.get(articleId);
                
                if (content) {
                    var searchTerm = searchInput ? searchInput.value.trim() : '';
                    var displayContent = content;
                    
                    if (searchTerm) {
                        displayContent = highlightInContent(content, searchTerm);
                    }
                    
                    contentDiv.innerHTML = 
                        '<div>' + displayContent + '</div>' +
                        '<div style="padding-top: 10px; border-top: 1px solid #eee; margin-top: 15px;">' +
                        '<button class="euaml-close-btn" onclick="this.closest(\'.euaml-article\').classList.remove(\'euaml-active\')">Schlie√üen</button>' +
                        '</div>';
                } else {
                    contentDiv.innerHTML = '<div><p><em>Artikel-Inhalt nicht verf√ºgbar.</em></p></div>';
                }
            }
            
            function highlightInContent(content, searchTerm) {
                if (!searchTerm || searchTerm.length < 2) return content;

                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;

                var searchTerms = searchTerm.toLowerCase().split(/\s+/).filter(function(term) {
                    return term.length > 1;
                });

                var walker = document.createTreeWalker(
                    tempDiv,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                var textNodes = [];
                var node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                for (var i = 0; i < textNodes.length; i++) {
                    var textNode = textNodes[i];
                    var text = textNode.textContent;
                    var highlightedText = text;

                    for (var j = 0; j < searchTerms.length; j++) {
                        var term = searchTerms[j];
                        var escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        var regex = new RegExp('(' + escapedTerm + ')', 'gi');
                        highlightedText = highlightedText.replace(regex, '<span class="euaml-search-highlight">$1</span>');
                    }

                    if (highlightedText !== text) {
                        var span = document.createElement('span');
                        span.innerHTML = highlightedText;
                        textNode.parentNode.replaceChild(span, textNode);
                    }
                }

                return tempDiv.innerHTML;
            }
            
            function handleSearch(searchText) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    renderSections(searchText);
                }, 300);
            }
            
            function initEventListeners() {
                if (lawSelector) {
                    lawSelector.addEventListener('change', function(e) {
                        currentLaw = e.target.value;
                        var lawConfig = AVAILABLE_LAWS[currentLaw];
                        
                        if (searchInput) {
                            searchInput.placeholder = 'Suche in ' + lawConfig.shortName + ' nach Artikeln oder Begriffen...';
                            searchInput.value = '';
                        }
                        
                        articleContents.clear();
                        sections = [];
                        
                        loadFromGitHub(lawConfig);
                    });
                }
                
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        handleSearch(e.target.value.trim());
                    });
                }
                
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function() {
                        var lawConfig = AVAILABLE_LAWS[currentLaw];
                        articleContents.clear();
                        sections = [];
                        
                        loadFromGitHub(lawConfig);
                    });
                }
            }
            
            function init() {
                console.log('Initialisiere Navigator...');
                
                if (!initElements()) {
                    console.error('DOM-Elemente nicht gefunden');
                    return;
                }
                
                initEventListeners();
                
                // Lade Standard-Gesetz
                var lawConfig = AVAILABLE_LAWS[currentLaw];
                loadFromGitHub(lawConfig);
                
                console.log('Navigator initialisiert');
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>
