<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesetzes-Navigator - Web-App</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            width: 100%;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #063AA8;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }

        .title {
            font-size: 24px;
            margin: 0;
            font-weight: 600;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            flex-shrink: 0;
        }

        .law-selector {
            background-color: #fff;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            color: #063AA8;
            cursor: pointer;
            min-width: 200px;
        }

        .law-selector:focus {
            outline: none;
            border-color: #063AA8;
            box-shadow: 0 0 0 3px rgba(6,58,168,0.1);
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 16px;
            border: 2px solid #DEE2E6;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #063AA8;
            box-shadow: 0 0 0 3px rgba(6,58,168,0.1);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #063AA8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: #063AA8;
            font-size: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .section {
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .section-title {
            color: white;
            font-weight: 600;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #063AA8 0%, #0066cc 100%);
            font-size: 18px;
        }

        .section-items {
            padding: 20px;
        }

        .paragraph {
            padding: 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .paragraph:hover {
            background: #F0F5FF;
            border-color: #DEE2E6;
            transform: translateY(-1px);
        }

        .paragraph.active {
            background: #E6F0FF;
            border-color: #063AA8;
        }

        .paragraph-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }

        .paragraph-content {
            display: none;
            padding: 25px;
            margin-top: 15px;
            background: #FFFFFF;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            font-size: 14px;
            line-height: 1.7;
            overflow-y: auto;
            max-height: 70vh;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .paragraph.active .paragraph-content {
            display: block;
        }

        .error {
            color: #E53E3E;
            padding: 20px;
            text-align: center;
            background: #FFF5F5;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #FED7D7;
        }

        .no-results {
            color: #64748b;
            padding: 40px;
            text-align: center;
            background: white;
            border-radius: 8px;
            font-size: 16px;
        }

        .jurAbsatz {
            margin: 1.2em 0;
            padding-left: 2.5em;
            position: relative;
            line-height: 1.6;
        }

        .jurAbsatz:before {
            content: attr(data-absatz);
            position: absolute;
            left: 0;
            font-weight: 600;
            color: #063AA8;
        }

        dl {
            margin: 0.8em 0 0.8em 2em;
        }

        dt {
            float: left;
            clear: left;
            margin-right: 0.8em;
            font-weight: 600;
            color: #063AA8;
            min-width: 2em;
        }

        dd {
            margin-bottom: 0.8em;
            margin-left: 3em;
            line-height: 1.6;
        }

        .content-match {
            background-color: #f0f7ff;
            border-left: 4px solid #063AA8;
        }

        .match-indicator {
            font-size: 0.85em;
            color: #0056b3;
            margin-left: 0.5em;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #e6f3ff;
            font-weight: 500;
        }

        .search-highlight {
            background-color: #fff3cd;
            padding: 0.1em 0.3em;
            border-radius: 0.3em;
            box-shadow: 0 0 0 1px #ffeeba;
            animation: highlight-fade-in 0.4s ease-out;
            font-weight: 600;
        }
        
        @keyframes highlight-fade-in {
            from {
                background-color: #ffd700;
            }
            to {
                background-color: #fff3cd;
            }
        }

        .collapse-button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 6px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #495057;
        }
        
        .collapse-button:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .stats-bar {
            background: #e6f3ff;
            padding: 15px 20px;
            border-bottom: 1px solid #b3d9ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #0056b3;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .offline-notice {
            background: #fff3cd;
            color: #856404;
            padding: 12px 20px;
            border-bottom: 1px solid #ffeaa7;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .law-selector, .search-input {
                min-width: auto;
                width: 100%;
            }
            
            .content {
                padding: 15px;
            }
            
            .paragraph-content {
                padding: 20px;
                font-size: 13px;
            }

            .section-title {
                font-size: 16px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">üìö Gesetzes-Navigator</h1>
        <div class="subtitle">Durchsuchbare Sammlung deutscher und EU-Gesetze</div>
    </div>
    
    <div class="offline-notice" id="offline-notice">
        ‚ö†Ô∏è Offline-Modus: Verwende lokale Daten
    </div>
    
    <div class="stats-bar">
        <div class="status-indicator">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">System startet...</span>
        </div>
        <div id="stats-info">Lade Statistiken...</div>
        <div id="last-update">Letzte Aktualisierung: wird geladen...</div>
    </div>
    
    <div class="controls">
        <select id="law-selector" class="law-selector">
            <optgroup label="Deutsche Gesetze">
                <option value="gwg_2017">Geldw√§schegesetz (GwG)</option>
                <option value="awg_2013">Au√üenwirtschaftsgesetz (AWG)</option>
                <option value="zag_2018">Zahlungsdiensteaufsichtsgesetz (ZAG)</option>
                <option value="kredwg">Kreditwesengesetz (KWG)</option>
            </optgroup>
            <optgroup label="EU-Verordnungen">
                <option value="eu_aml_2024">EU-Geldw√§scheverordnung 2024 (DE)</option>
                <option value="eu_ai_act_2024">EU-KI-Verordnung (AI Act)</option>
                <option value="eu_gdpr">EU-Datenschutz-Grundverordnung (DSGVO)</option>
            </optgroup>
        </select>
        
        <input type="text" class="search-input" placeholder="Suche nach Paragraphen, Artikeln oder Begriffen..." id="searchInput">
    </div>
    
    <div class="content" id="content"></div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Lade Gesetzes-Inhalte...</div>
    </div>

    <script>
        // ===== LOKALE DATEN-ARCHITEKTUR (CORS-frei) =====
        
        // Basis-Konfiguration 
        const APP_CONFIG = {
            version: '2.0.0',
            dataFormat: 'embedded',
            offlineFirst: true
        };

        // Eingebettete Gesetzes-Daten (CORS-frei)
        const LAWS_DATA = {
            'gwg_2017': {
                name: 'Geldw√§schegesetz (GwG)',
                shortName: 'GwG',
                type: 'german-law',
                lastUpdate: '2024-12-20',
                sections: [
                    {
                        number: 1,
                        title: "Begriffsbestimmungen, Verpflichtete und risikobasierter Ansatz",
                        items: [
                            {
                                number: "1",
                                title: "Anwendungsbereich",
                                content: `<div class="jnhtml">
<p>(1) Dieses Gesetz ist anzuwenden auf</p>
<dl>
<dt>1.</dt><dd>Kreditinstitute,</dd>
<dt>2.</dt><dd>Finanzdienstleistungsinstitute,</dd>
<dt>3.</dt><dd>Zahlungsinstitute und E-Geld-Institute,</dd>
<dt>4.</dt><dd>Kapitalverwaltungsgesellschaften,</dd>
<dt>5.</dt><dd>Investment-Kommanditgesellschaften nach dem Kapitalanlagegesetzbuch,</dd>
<dt>6.</dt><dd>Versicherungsunternehmen,</dd>
<dt>7.</dt><dd>Versicherungsvermittler und -berater,</dd>
<dt>8.</dt><dd>Spielbanken,</dd>
<dt>9.</dt><dd>Veranstalter und Vermittler von Gl√ºcksspielen im Internet,</dd>
<dt>10.</dt><dd>Immobilienmakler,</dd>
<dt>11.</dt><dd>Rechtsanw√§lte, Kammerrechtsbeist√§nde, Patentanw√§lte und Notare,</dd>
<dt>12.</dt><dd>Steuerberater, Steuerbevollm√§chtigte, Wirtschaftspr√ºfer und vereidigte Buchpr√ºfer,</dd>
<dt>13.</dt><dd>Dienstleister f√ºr Gesellschaften oder Trusts,</dd>
<dt>14.</dt><dd>G√ºterh√§ndler,</dd>
<dt>15.</dt><dd>Betreiber von Handelsplattformen f√ºr Kryptowerte und Kryptowertpapiere sowie Anbieter von Kryptoverwahrgesch√§ften,</dd>
<dt>16.</dt><dd>sonstige Gewerbetreibende, soweit sie Geldw√§sche betreiben oder Transaktionen in H√∂he von mindestens 10 000 Euro in bar entgegennehmen.</dd>
</dl>
<p>(2) Die Vorschriften dieses Gesetzes gelten entsprechend f√ºr Zweigniederlassungen und selbst√§ndige Zweigstellen von Verpflichteten mit Sitz im Ausland.</p>
</div>`,
                                type: 'paragraph'
                            },
                            {
                                number: "2",
                                title: "Begriffsbestimmungen",
                                content: `<div class="jnhtml">
<p>Im Sinne dieses Gesetzes ist</p>
<dl>
<dt>1.</dt><dd><strong>Geldw√§sche:</strong> die Verschleierung der Herkunft von Verm√∂gensgegenst√§nden, die aus einer Straftat stammen,</dd>
<dt>2.</dt><dd><strong>Terrorismusfinanzierung:</strong> die Bereitstellung oder Sammlung finanzieller Mittel in dem Wissen oder mit der Absicht, dass sie ganz oder teilweise dazu verwendet werden oder verwendet werden k√∂nnen,
<dl>
<dt>a)</dt><dd>eine Tat nach den ¬ß¬ß 129a bis 129f des Strafgesetzbuchs oder nach ¬ß 89a des Strafgesetzbuchs zu begehen,</dd>
<dt>b)</dt><dd>eine andere der in Artikel 1 bis 3 des Rahmenbeschlusses 2002/475/JI des Rates vom 13. Juni 2002 zur Terrorismusbek√§mpfung aufgef√ºhrten Straftaten zu begehen oder</dd>
<dt>c)</dt><dd>eine terroristische Vereinigung zu unterst√ºtzen,</dd>
</dl></dd>
<dt>3.</dt><dd><strong>Wirtschaftlich Berechtigter:</strong> die nat√ºrliche Person, in deren Eigentum oder unter deren Kontrolle der Vertragspartner letztendlich steht, oder die nat√ºrliche Person, auf deren Veranlassung eine Transaktion letztendlich durchgef√ºhrt oder eine Gesch√§ftsbeziehung letztendlich begr√ºndet wird,</dd>
<dt>4.</dt><dd><strong>Entsprechende Drittstaaten:</strong> Staaten, die nicht Mitgliedstaaten der Europ√§ischen Union sind und deren Systeme zur Bek√§mpfung der Geldw√§sche und der Terrorismusfinanzierung gleichwertige Anforderungen wie die der Europ√§ischen Union aufweisen.</dd>
</dl>
</div>`,
                                type: 'paragraph'
                            },
                            {
                                number: "3",
                                title: "Risikobasierter Ansatz",
                                content: `<div class="jnhtml">
<p>(1) Die Verpflichteten haben unter Ber√ºcksichtigung der von den zust√§ndigen Aufsichtsbeh√∂rden erstellten Risikoanalyse angemessene gesch√§ftspolitische Grunds√§tze, Verfahren und interne Kontrollen zur Verhinderung von Geldw√§sche und von Terrorismusfinanzierung zu schaffen und anzuwenden.</p>
<p>(2) Art und Umfang der zu treffenden Ma√ünahmen bestimmen sich nach dem jeweiligen Risiko der Gesch√§ftst√§tigkeit des Verpflichteten im Hinblick auf Geldw√§sche und Terrorismusfinanzierung.</p>
<p>(3) Die Verpflichteten haben ihre Ma√ünahmen zur Verhinderung von Geldw√§sche und von Terrorismusfinanzierung kontinuierlich zu √ºberpr√ºfen und bei Bedarf zu aktualisieren.</p>
</div>`,
                                type: 'paragraph'
                            }
                        ]
                    },
                    {
                        number: 2,
                        title: "Sorgfaltspflichten in Bezug auf Kunden",
                        items: [
                            {
                                number: "10",
                                title: "Allgemeine Sorgfaltspflichten",
                                content: `<div class="jnhtml">
<p>(1) Die Verpflichteten haben Sorgfaltspflichten in Bezug auf ihre Kunden zu erf√ºllen. Zu diesen Sorgfaltspflichten geh√∂ren:</p>
<dl>
<dt>1.</dt><dd>die Identifizierung des Vertragspartners und die √úberpr√ºfung der Identit√§t des Vertragspartners anhand von Dokumenten, Daten oder Informationen aus zuverl√§ssiger und unabh√§ngiger Quelle,</dd>
<dt>2.</dt><dd>die Identifizierung des wirtschaftlich Berechtigten und die Ergreifung angemessener Ma√ünahmen zur √úberpr√ºfung der Identit√§t des wirtschaftlich Berechtigten,</dd>
<dt>3.</dt><dd>die Einholung von Informationen √ºber Zweck und angestrebte Art der Gesch√§ftsbeziehung,</dd>
<dt>4.</dt><dd>die kontinuierliche √úberwachung der Gesch√§ftsbeziehung einschlie√ülich der in ihrem Verlauf durchgef√ºhrten Transaktionen.</dd>
</dl>
<p>(2) Die Sorgfaltspflichten sind zu erf√ºllen:</p>
<dl>
<dt>1.</dt><dd>bei der Begr√ºndung einer Gesch√§ftsbeziehung,</dd>
<dt>2.</dt><dd>bei der Durchf√ºhrung einer Transaktion au√üerhalb einer Gesch√§ftsbeziehung, die einen Geldbetrag von 15 000 Euro oder mehr umfasst,</dd>
<dt>3.</dt><dd>bei Zweifeln an der Echtheit oder Angemessenheit der zuvor erhobenen Angaben zur Identit√§t des Vertragspartners oder des wirtschaftlich Berechtigten,</dd>
<dt>4.</dt><dd>bei Transaktionen oder Gesch√§ftsbeziehungen mit Personen aus Hochrisikodrittl√§ndern.</dd>
</dl>
</div>`,
                                type: 'paragraph'
                            },
                            {
                                number: "11",
                                title: "Verst√§rkte Sorgfaltspflichten",
                                content: `<div class="jnhtml">
<p>(1) Die Verpflichteten haben √ºber die allgemeinen Sorgfaltspflichten hinaus verst√§rkte Sorgfaltspflichten zu erf√ºllen, wenn ein erh√∂htes Risiko der Geldw√§sche oder der Terrorismusfinanzierung vorliegt.</p>
<p>(2) Ein erh√∂htes Risiko liegt insbesondere vor bei:</p>
<dl>
<dt>1.</dt><dd>Transaktionen oder Gesch√§ftsbeziehungen mit politisch exponierten Personen,</dd>
<dt>2.</dt><dd>Transaktionen oder Gesch√§ftsbeziehungen mit Personen aus geografisch bedingt risikobehafteten Gebieten,</dd>
<dt>3.</dt><dd>ungew√∂hnlich komplexen oder au√üergew√∂hnlich gro√üvolumigen Transaktionen,</dd>
<dt>4.</dt><dd>ungew√∂hnlichen Transaktionsmustern ohne offensichtlichen wirtschaftlichen oder rechtm√§√üigen Zweck,</dd>
<dt>5.</dt><dd>Korrespondenzbeziehungen mit Respondenten mit Sitz in Drittstaaten.</dd>
</dl>
<p>(3) Zu den verst√§rkten Sorgfaltspflichten geh√∂ren:</p>
<dl>
<dt>1.</dt><dd>die Einholung zus√§tzlicher Informationen √ºber den Kunden,</dd>
<dt>2.</dt><dd>die Einholung zus√§tzlicher Informationen √ºber die angestrebte Art der Gesch√§ftsbeziehung,</dd>
<dt>3.</dt><dd>die Einholung von Informationen √ºber die Herkunft der Verm√∂genswerte des Kunden,</dd>
<dt>4.</dt><dd>die Durchf√ºhrung einer verst√§rkten kontinuierlichen √úberwachung der Gesch√§ftsbeziehung.</dd>
</dl>
</div>`,
                                type: 'paragraph'
                            }
                        ]
                    }
                ]
            },
            'eu_aml_2024': {
                name: 'EU-Geldw√§scheverordnung 2024',
                shortName: 'EU-GwVO',
                type: 'eu-regulation',
                lastUpdate: '2024-12-20',
                sections: [
                    {
                        number: 1,
                        title: "Allgemeine Bestimmungen",
                        items: [
                            {
                                number: "1",
                                title: "Gegenstand und Anwendungsbereich",
                                content: `<div class="eu-article">
<p>(1) Diese Verordnung legt harmonisierte Vorschriften zur Verhinderung der Nutzung des Finanzsystems der Union f√ºr die Zwecke der Geldw√§sche und der Terrorismusfinanzierung fest.</p>
<p>(2) Diese Verordnung gilt f√ºr folgende Verpflichtete:</p>
<ol type="a">
<li>Kreditinstitute;</li>
<li>Finanzinstitute;</li>
<li>Zahlungsdienstleister;</li>
<li>E-Geld-Institute;</li>
<li>Verwaltungsgesellschaften;</li>
<li>Versicherungsunternehmen und -vermittler;</li>
<li>Anbieter von Dienstleistungen im Zusammenhang mit virtuellen Verm√∂genswerten;</li>
<li>Immobilienmakler;</li>
<li>Rechtsanw√§lte, Notare und sonstige unabh√§ngige Angeh√∂rige der Rechtsberufe;</li>
<li>Wirtschaftspr√ºfer, externe Buchpr√ºfer und Steuerberater;</li>
<li>Anbieter von Treuhand- und Gesellschaftsdienstleistungen;</li>
<li>Gl√ºcksspieldienstleister;</li>
<li>H√§ndler mit hochwertigen G√ºtern;</li>
<li>Anbieter von Crowdfunding-Dienstleistungen.</li>
</ol>
</div>`,
                                type: 'article'
                            },
                            {
                                number: "2",
                                title: "Begriffsbestimmungen",
                                content: `<div class="eu-article">
<p>F√ºr die Zwecke dieser Verordnung bezeichnet der Ausdruck:</p>
<ol>
<li><strong>‚ÄûGeldw√§sche"</strong>: die in Artikel 1 der Richtlinie (EU) 2018/1673 genannten Handlungen;</li>
<li><strong>‚ÄûTerrorismusfinanzierung"</strong>: die Bereitstellung oder Sammlung von Geldern in der Absicht oder in dem Wissen, dass sie ganz oder teilweise f√ºr die Begehung einer der in den Artikeln 1 bis 4 der Richtlinie (EU) 2017/541 aufgef√ºhrten Straftaten verwendet werden sollen;</li>
<li><strong>‚ÄûVerpflichtete"</strong>: die in Artikel 1 Absatz 2 genannten nat√ºrlichen oder juristischen Personen;</li>
<li><strong>‚Äûwirtschaftlich Berechtigter"</strong>: die nat√ºrliche Person oder die nat√ºrlichen Personen, die letztendlich Eigent√ºmer einer juristischen Person sind oder diese kontrollieren;</li>
<li><strong>‚Äûpolitisch exponierte Person"</strong>: eine nat√ºrliche Person, die wichtige √∂ffentliche √Ñmter aus√ºbt oder ausge√ºbt hat;</li>
<li><strong>‚ÄûHochrisikodrittl√§nder"</strong>: L√§nder, die von der Kommission gem√§√ü Artikel 9 der Richtlinie (EU) 2015/849 ermittelt wurden.</li>
</ol>
</div>`,
                                type: 'article'
                            }
                        ]
                    },
                    {
                        number: 2,
                        title: "Sorgfaltspflichten gegen√ºber Kunden",
                        items: [
                            {
                                number: "19",
                                title: "Allgemeine Bestimmungen zur Sorgfaltspflicht gegen√ºber Kunden",
                                content: `<div class="eu-article">
<p>(1) Die Verpflichteten wenden Sorgfaltspflichten gegen√ºber Kunden in folgenden F√§llen an:</p>
<ol type="a">
<li>bei der Begr√ºndung einer Gesch√§ftsbeziehung;</li>
<li>bei der Durchf√ºhrung gelegentlicher Transaktionen
<ol type="i">
<li>im Wert von 10 000 EUR oder mehr, unabh√§ngig davon, ob die Transaktion in einem einzigen Vorgang oder in mehreren Vorg√§ngen durchgef√ºhrt wird, die miteinander verkn√ºpft zu sein scheinen, oder</li>
<li>die eine √úbertragung von Geldern im Sinne der Verordnung (EU) 2015/847 darstellen;</li>
</ol>
</li>
<li>bei Verdacht auf Geldw√§sche oder Terrorismusfinanzierung;</li>
<li>bei Zweifeln an der Wahrhaftigkeit oder Angemessenheit zuvor erhaltener Kundendaten.</li>
</ol>
<p>(2) Die Sorgfaltspflichten gegen√ºber Kunden umfassen:</p>
<ol type="a">
<li>die Identifizierung des Kunden und die √úberpr√ºfung der Identit√§t des Kunden;</li>
<li>die Identifizierung des wirtschaftlich Berechtigten und die Ergreifung angemessener Ma√ünahmen zur √úberpr√ºfung seiner Identit√§t;</li>
<li>die Bewertung und gegebenenfalls die Einholung von Informationen √ºber den Zweck und die angestrebte Art der Gesch√§ftsbeziehung oder Transaktion;</li>
<li>die laufende √úberwachung der Gesch√§ftsbeziehung.</li>
</ol>
</div>`,
                                type: 'article'
                            }
                        ]
                    }
                ]
            }
        };

        // Globale Variablen
        let currentLaw = 'gwg_2017';
        let currentSections = [];
        let isLoading = false;
        let isOffline = false;

        // DOM-Elemente
        const content = document.getElementById('content');
        const searchInput = document.getElementById('searchInput');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const lawSelector = document.getElementById('law-selector');
        const statsInfo = document.getElementById('stats-info');
        const lastUpdate = document.getElementById('last-update');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const offlineNotice = document.getElementById('offline-notice');

        // Hilfsfunktionen
        function showLoading(text = 'Lade Inhalte...') {
            loadingText.textContent = text;
            loading.style.display = 'flex';
            isLoading = true;
        }

        function hideLoading() {
            loading.style.display = 'none';
            isLoading = false;
        }

        function showError(message) {
            content.innerHTML = `
                <div class="error">
                    <strong>Fehler:</strong><br>
                    ${message}
                </div>
            `;
        }

        function updateStatus(status, message) {
            statusText.textContent = message;
            if (status === 'online') {
                statusDot.style.background = '#10b981';
                offlineNotice.style.display = 'none';
                isOffline = false;
            } else if (status === 'offline') {
                statusDot.style.background = '#f59e0b';
                offlineNotice.style.display = 'block';
                isOffline = true;
            } else if (status === 'error') {
                statusDot.style.background = '#ef4444';
                offlineNotice.style.display = 'none';
            }
        }

        function updateStats(lawCount = 0, sectionCount = 0) {
            const lawConfig = LAWS_DATA[currentLaw];
            if (lawConfig) {
                statsInfo.textContent = `${lawConfig.name} ‚Ä¢ ${sectionCount} Abschnitte ‚Ä¢ ${lawCount} ${lawConfig.type === 'eu-regulation' ? 'Artikel' : 'Paragraphen'}`;
                lastUpdate.textContent = `Letzte Aktualisierung: ${lawConfig.lastUpdate}`;
            }
        }

        // Such-Funktionalit√§t
        function normalizeSearchTerm(term) {
            return term.toLowerCase()
                .replace(/¬ß\s*/g, '¬ß')
                .replace(/abs\./i, 'absatz')
                .replace(/abs$/i, 'absatz')
                .replace(/nr\./i, 'nummer')
                .replace(/nr$/i, 'nummer')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();
        }

        function matchesSearch(text, searchTerm, lawType = 'german') {
            if (!searchTerm) return true;
            
            const normalizedText = normalizeSearchTerm(text);
            const normalizedSearch = normalizeSearchTerm(searchTerm);
            
            if (lawType === 'eu-regulation') {
                // Artikel-Suche f√ºr EU-Verordnungen
                const articleMatch = searchTerm.match(/art(?:ikel)?\s*\.?\s*(\d+[a-z]?)/i);
                if (articleMatch) {
                    const searchArtNum = parseInt(articleMatch[1], 10);
                    if (text.match(new RegExp(`^artikel\\s*${searchArtNum}\\b`, 'i')) || 
                        text.match(new RegExp(`^art\\.?\\s*${searchArtNum}\\b`, 'i'))) {
                        return true;
                    }
                }
            } else {
                // Paragraphen-Suche f√ºr deutsche Gesetze
                const paragraphMatch = searchTerm.match(/¬ß\s*(\d+[a-z]?)/i);
                if (paragraphMatch) {
                    const searchParaNum = parseInt(paragraphMatch[1], 10);
                    if (text.match(new RegExp(`^¬ß\\s*${searchParaNum}\\b`))) {
                        return true;
                    }
                }
            }
            
            // Normale Textsuche
            return normalizedText.includes(normalizedSearch);
        }

        function highlightSearchTerm(content, searchTerm) {
            if (!searchTerm) return content;
            
            const searchTerms = searchTerm.split(/\s+/).filter(term => term.length > 2);
            let modifiedContent = content;
            
            for (const term of searchTerms) {
                const escapedSearchTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                modifiedContent = modifiedContent.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            return modifiedContent;
        }

        // Zeige Abschnitte an
        function renderSections(sections, filter = '') {
            if (!content) return;
            
            const searchText = filter.toLowerCase();
            content.innerHTML = '';
            
            let hasResults = false;
            let totalItems = 0;
            
            for (const section of sections) {
                if (section.items.length === 0) continue;
                
                const filteredItems = [];
                
                for (const item of section.items) {
                    const lawConfig = LAWS_DATA[currentLaw];
                    const searchableTitle = `${lawConfig.type === 'eu-regulation' ? 'Art.' : '¬ß'} ${item.number} ${item.title}`;
                    
                    if (!searchText || matchesSearch(searchableTitle, searchText, lawConfig.type)) {
                        filteredItems.push({item, contentMatch: false});
                        hasResults = true;
                        totalItems++;
                    }
                }
                
                if (filteredItems.length > 0) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section';
                    
                    const sectionTitle = document.createElement('h2');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = `Abschnitt ${section.number}: ${section.title}`;
                    sectionDiv.appendChild(sectionTitle);
                    
                    const sectionItems = document.createElement('div');
                    sectionItems.className = 'section-items';
                    
                    filteredItems.forEach(({item, contentMatch}) => {
                        const paragraphDiv = document.createElement('div');
                        paragraphDiv.className = `paragraph ${contentMatch ? 'content-match' : ''}`;
                        paragraphDiv.dataset.number = item.number;
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'paragraph-title';
                        const lawConfig = LAWS_DATA[currentLaw];
                        titleDiv.innerHTML = `
                            ${lawConfig.type === 'eu-regulation' ? 'Art.' : '¬ß'} ${item.number} - ${item.title}
                            ${contentMatch ? '<span class="match-indicator">(Treffer im Inhalt)</span>' : ''}
                        `;
                        
                        paragraphDiv.appendChild(titleDiv);
                        sectionItems.appendChild(paragraphDiv);
                        
                        // Event-Listener f√ºr Klick
                        paragraphDiv.addEventListener('click', function() {
                            toggleParagraphContent(this, item, filter);
                        });
                    });
                    
                    sectionDiv.appendChild(sectionItems);
                    content.appendChild(sectionDiv);
                }
            }
            
            // Zeige "Keine Ergebnisse" wenn n√∂tig
            if (!hasResults) {
                content.innerHTML = `
                    <div class="no-results">
                        ${searchText ? `Keine Ergebnisse f√ºr "${filter}" gefunden.` : 'Keine Inhalte verf√ºgbar.'}
                    </div>
                `;
            }
            
            updateStats(totalItems, sections.filter(s => s.items.length > 0).length);
        }

        // Toggle Paragraph/Artikel-Inhalt
        function toggleParagraphContent(element, item, searchTerm = '') {
            const hasSelection = window.getSelection().toString().length > 0;
            if (hasSelection) return;
            
            // Schlie√üe andere ge√∂ffnete Paragraphen
            document.querySelectorAll('.paragraph').forEach(p => {
                if (p !== element) {
                    p.classList.remove('active');
                    const content = p.querySelector('.paragraph-content');
                    if (content) content.remove();
                }
            });
            
            const wasActive = element.classList.contains('active');
            if (wasActive) {
                const content = element.querySelector('.paragraph-content');
                if (content) content.remove();
                element.classList.remove('active');
                return;
            }
            
            element.classList.add('active');
            
            // Erstelle Content-Container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'paragraph-content';
            
            // Zeige lokalen Inhalt (CORS-frei!)
            let displayContent = item.content;
            
            // Wende Highlighting an
            if (searchTerm) {
                displayContent = highlightSearchTerm(displayContent, searchTerm);
            }
            
            // Formatiere Abs√§tze
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = displayContent;
            
            tempDiv.querySelectorAll('.jurAbsatz').forEach((absatz) => {
                const text = absatz.innerText;
                const match = text.match(/^\((\d+)\)/);
                if (match) {
                    absatz.setAttribute('data-absatz', `(${match[1]})`);
                    absatz.innerHTML = absatz.innerHTML.replace(/^\(\d+\)/, '').trim();
                }
            });
            
            contentDiv.innerHTML = `
                <div style="user-select: text; cursor: text;">
                    ${tempDiv.innerHTML}
                </div>
                <button class="collapse-button" onclick="this.parentElement.parentElement.classList.remove('active'); this.parentElement.remove();">
                    Schlie√üen
                </button>
            `;
            
            element.appendChild(contentDiv);
        }

        // Such-Funktionalit√§t
        function performSearch() {
            if (isLoading) return;
            
            const searchText = searchInput.value.trim();
            renderSections(currentSections, searchText);
        }

        // Gesetz laden (lokale Daten)
        function loadLaw(lawKey) {
            if (isLoading) return;
            
            showLoading(`Lade ${LAWS_DATA[lawKey].name}...`);
            
            currentLaw = lawKey;
            
            // Simuliere kurze Ladezeit f√ºr bessere UX
            setTimeout(() => {
                try {
                    const lawData = LAWS_DATA[lawKey];
                    
                    if (lawData && lawData.sections) {
                        currentSections = lawData.sections;
                        renderSections(currentSections);
                        updateStatus('online', 'System bereit');
                        
                        // Speichere Auswahl
                        localStorage.setItem('lastSelectedLaw', lawKey);
                    } else {
                        throw new Error('Gesetzes-Daten nicht verf√ºgbar');
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des Gesetzes:', error);
                    showError(`Konnte das ${LAWS_DATA[lawKey].name} nicht laden: ${error.message}`);
                    updateStatus('error', 'Fehler beim Laden');
                } finally {
                    hideLoading();
                }
            }, 300);
        }

        // Event-Listener
        if (lawSelector) {
            lawSelector.addEventListener('change', function(e) {
                loadLaw(e.target.value);
            });
        }

        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchText = this.value.trim();
                searchTimeout = setTimeout(() => {
                    performSearch();
                }, searchText.length > 2 ? 300 : 0);
            });
        }

        // Erweiterte Kopier-Funktionalit√§t mit Zitierung
        document.addEventListener('copy', (e) => {
            const selection = window.getSelection();
            if (!selection.toString().trim()) return;
            
            const selectedText = selection.toString().trim();
            const lawConfig = LAWS_DATA[currentLaw];
            
            // Finde den Kontext des ausgew√§hlten Texts
            let paragraphNumber = '';
            let element = selection.anchorNode;
            
            // Gehe nach oben bis zum Paragraph-Element
            while (element && element !== document) {
                if (element.closest && element.closest('.paragraph')) {
                    const paragraphEl = element.closest('.paragraph');
                    paragraphNumber = paragraphEl.dataset.number || '';
                    break;
                }
                element = element.parentNode;
            }
            
            if (lawConfig && paragraphNumber) {
                e.preventDefault();
                const prefix = lawConfig.type === 'eu-regulation' ? 'Art.' : '¬ß';
                const formattedText = `"${selectedText}" ${prefix} ${paragraphNumber} ${lawConfig.shortName}`;
                e.clipboardData.setData('text/plain', formattedText);
                
                // Feedback f√ºr den Benutzer
                updateStatus('online', 'Text mit Verweis kopiert');
                setTimeout(() => {
                    updateStatus('online', 'System bereit');
                }, 2000);
            }
        });

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('online', 'Initialisiere...');
            
            // Letztes ausgew√§hltes Gesetz wiederherstellen
            const lastLaw = localStorage.getItem('lastSelectedLaw');
            if (lastLaw && LAWS_DATA[lastLaw]) {
                currentLaw = lastLaw;
                lawSelector.value = currentLaw;
            }
            
            // Erstes Gesetz laden
            loadLaw(currentLaw);
            
            // Fokussiere Suchfeld
            setTimeout(() => {
                searchInput.focus();
            }, 500);
        });
    </script>
</body>
</html>
