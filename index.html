<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EU-Gesetzes Navigator - Enhanced Auto-Updates</title>
    <style>
        .euaml-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .euaml-header {
            background: linear-gradient(135deg, #063AA8 0%, #1E40AF 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .euaml-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .euaml-auto-badge {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .euaml-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .euaml-law-selector {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.2);
            color: #063AA8;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 200px;
        }

        .euaml-refresh-btn {
            background: rgba(34, 197, 94, 0.9);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .euaml-refresh-btn:hover {
            background: rgba(34, 197, 94, 1);
            transform: translateY(-1px);
        }

        .euaml-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .euaml-info-banner {
            background: linear-gradient(90deg, #E0F2FE 0%, #F0F9FF 100%);
            border-bottom: 1px solid #7DD3FC;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #0369A1;
        }

        .euaml-github-link {
            color: #1D4ED8;
            text-decoration: none;
            font-weight: 500;
        }

        .euaml-github-link:hover {
            text-decoration: underline;
        }

        .euaml-search-section {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .euaml-search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #DEE2E6;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .euaml-search-input:focus {
            outline: none;
            border-color: #063AA8;
            box-shadow: 0 0 0 3px rgba(6,58,168,0.1);
        }

        .euaml-main-content {
            overflow-y: auto;
            padding: 15px 20px;
            flex: 1;
        }

        .euaml-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .euaml-section:last-child {
            border-bottom: none;
        }

        .euaml-section-title {
            color: #063AA8;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .euaml-update-time {
            font-size: 11px;
            color: #666;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .euaml-article {
            margin: 8px 0;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .euaml-article:hover {
            background: #F0F5FF;
            border-color: #DEE2E6;
        }

        .euaml-article.euaml-active {
            background: #E6F0FF;
            border-color: #063AA8;
        }

        .euaml-content-match {
            background-color: #f0f7ff;
            border-left: 3px solid #063AA8;
        }

        .euaml-article-title {
            padding: 10px 12px;
            font-weight: 500;
            color: #333;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .euaml-article-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .euaml-article-content {
            display: none;
            padding: 20px;
            background: #FFFFFF;
            border-top: 1px solid #E2E8F0;
            font-size: 14px;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
            user-select: text;
            cursor: text;
        }

        .euaml-article.euaml-active .euaml-article-content {
            display: block;
        }

        .euaml-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #666;
            flex-direction: column;
            gap: 15px;
        }

        .euaml-loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #063AA8;
            border-radius: 50%;
            animation: euaml-spin 1s linear infinite;
        }

        @keyframes euaml-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .euaml-error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #e53e3e;
            padding: 15px;
            border-radius: 4px;
            margin: 15px;
        }

        .euaml-success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 15px;
            border-radius: 4px;
            margin: 15px;
        }

        .euaml-search-highlight {
            background-color: #fff3cd;
            padding: 0.1em 0.2em;
            border-radius: 0.2em;
            box-shadow: 0 0 0 1px #ffeeba;
        }

        .euaml-close-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            user-select: none;
        }

        .euaml-close-btn:hover {
            background: #e9ecef;
        }

        .law-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .law-badge.eu-aml {
            background: #063AA8;
            color: white;
        }

        .law-badge.gdpr {
            background: #8B5CF6;
            color: white;
        }

        .law-badge.ai-act {
            background: #059669;
            color: white;
        }

        .law-badge.dsa {
            background: #DC2626;
            color: white;
        }

        /* Deutsche Gesetze Badges */
        .law-badge.de-gwg {
            background: #B91C1C;
            color: white;
        }

        .law-badge.de-kwg {
            background: #1F2937;
            color: white;
        }

        .law-badge.de-zag {
            background: #7C3AED;
            color: white;
        }

        .law-badge.de-awg {
            background: #EA580C;
            color: white;
        }

        .law-badge.de-awv {
            background: #F59E0B;
            color: white;
        }

        .law-badge.de-stgb {
            background: #991B1B;
            color: white;
        }

        .law-badge.de-vag {
            background: #0891B2;
            color: white;
        }

        .law-badge.de-kagb {
            background: #059669;
            color: white;
        }

        .law-badge.de-wphg {
            background: #0D9488;
            color: white;
        }

        .law-badge.de-sanktdg {
            background: #DC2626;
            color: white;
        }

        .law-badge.default {
            background: #6B7280;
            color: white;
        }

        /* Enhanced Redirect Content Styling */
        .redirect-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .redirect-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .redirect-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .source-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }

        .source-card h4 {
            margin: 0 0 8px 0;
            color: #1e40af;
            font-size: 14px;
            font-weight: 600;
        }

        .source-card p {
            margin: 0 0 12px 0;
            color: #64748b;
            font-size: 12px;
            line-height: 1.4;
        }

        .source-btn {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .source-btn:hover {
            background: #2563eb;
        }

        .source-btn.secondary {
            background: #6b7280;
        }

        .source-btn.secondary:hover {
            background: #4b5563;
        }

        /* Markdown Content Styling für echte Gesetze */
        .markdown-content {
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: #1e40af;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
            margin: 20px 0 15px 0;
        }

        .markdown-content h1 {
            font-size: 20px;
        }

        .markdown-content h2 {
            font-size: 18px;
        }

        .markdown-content h3 {
            font-size: 16px;
        }

        .markdown-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .markdown-content li {
            margin: 5px 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
            margin: 15px 0;
            padding: 10px 15px;
            font-style: italic;
        }

        .markdown-content code {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .content-type-indicator {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .content-type-indicator.redirect {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        @media (max-width: 768px) {
            .euaml-container {
                margin: 10px;
                border-radius: 4px;
                height: 95vh;
            }
            
            .euaml-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .euaml-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .euaml-law-selector {
                min-width: unset;
                flex: 1;
            }

            .sources-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="euaml-container" id="euamlContainer">
        <div class="euaml-header">
            <h1 class="euaml-title">
                🇪🇺 EU-Gesetzes Navigator
                <span class="euaml-auto-badge">Enhanced Auto-Update</span>
            </h1>
            <div class="euaml-controls">
                <select class="euaml-law-selector" id="euamlLawSelector">
                    <optgroup label="🇪🇺 EU-Verordnungen">
                        <option value="eu_aml_2024">EU-Geldwäscheverordnung 2024</option>
                        <option value="eu_gdpr_2016">EU-Datenschutz-Grundverordnung (GDPR)</option>
                        <option value="eu_ai_act_2024">EU-KI-Verordnung (AI Act) 2024</option>
                        <option value="eu_dsa_2022">Digital Services Act 2022</option>
                    </optgroup>
                    <optgroup label="🏦 Deutsche Gesetze - Geldwäscheprävention">
                        <option value="de_gwg_2017">Geldwäschegesetz (GwG)</option>
                        <option value="de_kwg">Kreditwesengesetz (KWG)</option>
                        <option value="de_zag_2018">Zahlungsdiensteaufsichtsgesetz (ZAG)</option>
                        <option value="de_vag_2016">Versicherungsaufsichtsgesetz (VAG)</option>
                    </optgroup>
                    <optgroup label="🌍 Deutsche Gesetze - Sanktionen & Außenwirtschaft">
                        <option value="de_awg">Außenwirtschaftsgesetz (AWG)</option>
                        <option value="de_awv_2013">Außenwirtschaftsverordnung (AWV)</option>
                        <option value="de_eu_sanktdg">EU-Sanktions-Durchführungsgesetz</option>
                    </optgroup>
                    <optgroup label="📈 Deutsche Gesetze - Kapitalmarkt & Investitionen">
                        <option value="de_kagb">Kapitalanlagegesetzbuch (KAGB)</option>
                        <option value="de_wphg">Wertpapierhandelsgesetz (WpHG)</option>
                    </optgroup>
                    <optgroup label="⚖️ Deutsche Gesetze - Strafrecht">
                        <option value="de_stgb">Strafgesetzbuch (StGB) - §261 Geldwäsche</option>
                    </optgroup>
                </select>
                <button class="euaml-refresh-btn" id="euamlRefreshBtn">🔄 Neu laden</button>
            </div>
        </div>
        <div class="euaml-content" id="euamlContent">
            <div class="euaml-info-banner">
                <span>🤖</span>
                <span id="statusBanner">
                    <strong>Täglich automatisch aktualisiert</strong> um 6:00 Uhr | 
                    EU-Verordnungen: zuverlässig | Deutsche Gesetze: enhanced sources via 
                    <a href="#" class="euaml-github-link" id="githubLink" target="_blank">GitHub Actions</a>
                </span>
            </div>
            <div class="euaml-search-section">
                <input type="text" class="euaml-search-input" id="euamlSearchInput" 
                       placeholder="Suche nach Artikeln oder Begriffen... (z.B. 'Art. 1', 'Begriffsbestimmungen')">
            </div>
            <div class="euaml-main-content" id="euamlMainContent">
                <div class="euaml-loading">
                    <div class="euaml-loading-spinner"></div>
                    <span>Lade automatisch aktualisierte Gesetze...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            console.log('🚀 Enhanced EU-Gesetzes Navigator startet...');
            
            // GitHub-Konfiguration automatisch ermitteln
            function detectGitHubConfig() {
                var currentHost = window.location.hostname;
                var currentPath = window.location.pathname;
                
                if (currentHost.includes('github.io')) {
                    // GitHub Pages deployment
                    var hostParts = currentHost.split('.');
                    var username = hostParts[0];
                    
                    var pathParts = currentPath.split('/').filter(Boolean);
                    var repository = pathParts[0] || 'eu-gesetzes-navigator';
                    
                    return {
                        username: username,
                        repository: repository,
                        branch: 'main'
                    };
                }
                
                // Fallback-Konfiguration - Nutzer sollte diese anpassen
                console.warn('⚠️ WICHTIG: Bitte passen Sie die GitHub-Konfiguration unten an!');
                return {
                    username: 'obenning',      // ⚠️ HIER ANPASSEN
                    repository: 'eu-laws-navigator',    // ⚠️ HIER ANPASSEN
                    branch: 'main'
                };
            }
            
            const GITHUB_CONFIG = detectGitHubConfig();
            console.log('📁 GitHub Config:', GITHUB_CONFIG);
            
            // Konfiguration der verfügbaren Gesetze
            const AVAILABLE_LAWS = {
                // EU-Verordnungen
                'eu_aml_2024': {
                    name: 'EU-Geldwäscheverordnung 2024',
                    shortName: 'EU-GwVO',
                    filename: 'eu-aml-2024.html',
                    celex: '32024R1624',
                    type: 'eu-regulation',
                    color: '#063AA8'
                },
                'eu_gdpr_2016': {
                    name: 'EU-Datenschutz-Grundverordnung',
                    shortName: 'GDPR',
                    filename: 'eu-gdpr-2016.html',
                    celex: '32016R0679',
                    type: 'eu-regulation',
                    color: '#8B5CF6'
                },
                'eu_ai_act_2024': {
                    name: 'EU-KI-Verordnung (AI Act)',
                    shortName: 'AI Act',
                    filename: 'eu-ai-act-2024.html',
                    celex: '32024R1689',
                    type: 'eu-regulation',
                    color: '#059669'
                },
                'eu_dsa_2022': {
                    name: 'Digital Services Act',
                    shortName: 'DSA',
                    filename: 'eu-dsa-2022.html',
                    celex: '32022R2065',
                    type: 'eu-regulation',
                    color: '#DC2626'
                },
                
                // Deutsche Gesetze
                'de_gwg_2017': {
                    name: 'Geldwäschegesetz (GwG)',
                    shortName: 'GwG',
                    filename: 'de-gwg-2017.html',
                    type: 'german-law',
                    category: 'aml',
                    color: '#B91C1C'
                },
                'de_kwg': {
                    name: 'Kreditwesengesetz (KWG)',
                    shortName: 'KWG',
                    filename: 'de-kwg.html',
                    type: 'german-law',
                    category: 'banking',
                    color: '#1F2937'
                },
                'de_zag_2018': {
                    name: 'Zahlungsdiensteaufsichtsgesetz (ZAG)',
                    shortName: 'ZAG',
                    filename: 'de-zag-2018.html',
                    type: 'german-law',
                    category: 'payments',
                    color: '#7C3AED'
                },
                'de_awg': {
                    name: 'Außenwirtschaftsgesetz (AWG)',
                    shortName: 'AWG',
                    filename: 'de-awg.html',
                    type: 'german-law',
                    category: 'sanctions',
                    color: '#EA580C'
                },
                'de_awv_2013': {
                    name: 'Außenwirtschaftsverordnung (AWV)',
                    shortName: 'AWV',
                    filename: 'de-awv-2013.html',
                    type: 'german-law',
                    category: 'sanctions',
                    color: '#F59E0B'
                },
                'de_stgb': {
                    name: 'Strafgesetzbuch (StGB)',
                    shortName: 'StGB',
                    filename: 'de-stgb.html',
                    type: 'german-law',
                    category: 'criminal',
                    color: '#991B1B'
                },
                'de_vag_2016': {
                    name: 'Versicherungsaufsichtsgesetz (VAG)',
                    shortName: 'VAG',
                    filename: 'de-vag-2016.html',
                    type: 'german-law',
                    category: 'insurance',
                    color: '#0891B2'
                },
                'de_kagb': {
                    name: 'Kapitalanlagegesetzbuch (KAGB)',
                    shortName: 'KAGB',
                    filename: 'de-kagb.html',
                    type: 'german-law',
                    category: 'investments',
                    color: '#059669'
                },
                'de_wphg': {
                    name: 'Wertpapierhandelsgesetz (WpHG)',
                    shortName: 'WpHG',
                    filename: 'de-wphg.html',
                    type: 'german-law',
                    category: 'securities',
                    color: '#0D9488'
                },
                'de_eu_sanktdg': {
                    name: 'EU-Sanktions-Durchführungsgesetz',
                    shortName: 'EU-SanktDG',
                    filename: 'de-eu-sanktdg.html',
                    type: 'german-law',
                    category: 'sanctions',
                    color: '#DC2626'
                }
            };
            
            var currentLaw = 'eu_aml_2024';
            var sections = [];
            var articleContents = new Map();
            var searchTimeout = null;
            var lastUpdateTime = null;
            var currentContentType = 'unknown'; // 'real', 'redirect', 'unknown'
            
            var container = null;
            var content = null;
            var searchInput = null;
            var mainContent = null;
            var lawSelector = null;
            var refreshBtn = null;
            var githubLink = null;
            var statusBanner = null;
            
            function initElements() {
                container = document.getElementById('euamlContainer');
                content = document.getElementById('euamlContent');
                searchInput = document.getElementById('euamlSearchInput');
                mainContent = document.getElementById('euamlMainContent');
                lawSelector = document.getElementById('euamlLawSelector');
                refreshBtn = document.getElementById('euamlRefreshBtn');
                githubLink = document.getElementById('githubLink');
                statusBanner = document.getElementById('statusBanner');
                
                // GitHub-Link setzen
                if (githubLink) {
                    githubLink.href = `https://github.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/tree/${GITHUB_CONFIG.branch}/laws`;
                }

                if (!container || !content || !searchInput || !mainContent || !lawSelector) {
                    console.error('❌ Konnte nicht alle DOM-Elemente finden');
                    return false;
                }
                return true;
            }
            
            function showError(message) {
                if (mainContent) {
                    mainContent.innerHTML = 
                        '<div class="euaml-error">' +
                        '<strong>Fehler:</strong><br>' + message +
                        '<br><br>' +
                        '💡 <strong>Tipp:</strong> Prüfen Sie die GitHub-Repository-Konfiguration.' +
                        '<br><strong>Aktuell:</strong> ' + GITHUB_CONFIG.username + '/' + GITHUB_CONFIG.repository +
                        '</div>';
                }
            }
            
            function showSuccess(message) {
                if (mainContent) {
                    var notification = document.createElement('div');
                    notification.className = 'euaml-success';
                    notification.innerHTML = message;
                    mainContent.insertBefore(notification, mainContent.firstChild);
                    
                    setTimeout(function() {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                }
            }
            
            function getGitHubRawUrl(filename) {
                return `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/${GITHUB_CONFIG.branch}/laws/${filename}`;
            }
            
            async function loadUpdateMetadata() {
                try {
                    const metadataUrl = getGitHubRawUrl('last-update.json');
                    console.log('📊 Lade Update-Metadaten von:', metadataUrl);
                    
                    const response = await fetch(metadataUrl + '?t=' + Date.now());
                    
                    if (!response.ok) {
                        throw new Error(`Metadaten nicht verfügbar: ${response.status}`);
                    }
                    
                    const metadata = await response.json();
                    lastUpdateTime = new Date(metadata.last_update);
                    
                    console.log('✅ Metadaten geladen - Letztes Update:', lastUpdateTime.toLocaleString('de-DE'));
                    
                    // Update Status Banner
                    updateStatusBanner(metadata);
                    
                    return metadata;
                    
                } catch (error) {
                    console.warn('⚠️ Metadaten konnten nicht geladen werden:', error);
                    return null;
                }
            }
            
            function updateStatusBanner(metadata) {
                if (!statusBanner || !metadata) return;
                
                const stats = metadata.statistics || {};
                const euStats = stats.eu_laws || {};
                const deStats = stats.german_laws || {};
                
                const euCount = euStats.available || 0;
                const deRealCount = deStats.real_content || 0;
                const deFallbackCount = deStats.fallback_redirects || 0;
                
                statusBanner.innerHTML = `
                    <strong>Enhanced Auto-Update</strong> um 6:00 Uhr | 
                    🇪🇺 EU: ${euCount}/4 (${euStats.success_rate || '0%'}) | 
                    🏛️ DE-echt: ${deRealCount}/10 | 
                    📄 DE-redirects: ${deFallbackCount}/10 | 
                    <a href="#" class="euaml-github-link" id="githubLink" target="_blank">Enhanced Sources</a>
                `;
                
                // GitHub-Link neu setzen
                const newGithubLink = document.getElementById('githubLink');
                if (newGithubLink) {
                    newGithubLink.href = `https://github.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/tree/${GITHUB_CONFIG.branch}/laws`;
                }
            }
            
            async function loadFromGitHub(lawConfig) {
                console.log('📥 Lade von GitHub:', lawConfig.name);
                
                if (mainContent) {
                    mainContent.innerHTML = 
                        '<div class="euaml-loading">' +
                        '<div class="euaml-loading-spinner"></div>' +
                        '<span>Lade ' + lawConfig.name + ' von Enhanced Sources...</span>' +
                        '</div>';
                }
                
                try {
                    // Lade zuerst Metadaten
                    await loadUpdateMetadata();
                    
                    const fileUrl = getGitHubRawUrl(lawConfig.filename);
                    console.log('📄 Lade Gesetz von:', fileUrl);
                    
                    const response = await fetch(fileUrl + '?t=' + Date.now(), {
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const html = await response.text();
                    
                    if (!html || html.length < 500) {
                        throw new Error('Datei zu kurz oder leer');
                    }
                    
                    console.log('✅', lawConfig.name + ' erfolgreich geladen:', html.length, 'Zeichen');
                    
                    // Analysiere Content-Typ
                    const contentType = analyzeContentType(html);
                    currentContentType = contentType;
                    
                    console.log('🔍 Content-Typ erkannt:', contentType);
                    
                    parseContent(html, lawConfig, contentType);
                    
                    const updateInfo = lastUpdateTime ? 
                        ` (Letztes Update: ${lastUpdateTime.toLocaleString('de-DE')})` : '';
                    const typeInfo = contentType === 'real' ? ' (Echter Gesetzestext)' : 
                                   contentType === 'redirect' ? ' (Enhanced Redirect)' : '';
                    showSuccess(`✅ ${lawConfig.name} erfolgreich geladen!${typeInfo}${updateInfo}`);
                    
                } catch (error) {
                    console.error('❌ GitHub-Fehler:', error);
                    showError(`Fehler beim Laden von ${lawConfig.name}: ${error.message}<br><br>` +
                        `Prüfen Sie: <br>` +
                        `• Repository: ${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}<br>` +
                        `• Datei: laws/${lawConfig.filename}<br>` +
                        `• GitHub Actions Workflow aktiv?`);
                    loadFallback(lawConfig);
                }
            }
            
            function analyzeContentType(html) {
                // Prüfe auf Enhanced Redirect Indikatoren
                const redirectIndicators = [
                    'Automatische Weiterleitung',
                    'Automatische Suche aktiv',
                    'Enhanced Redirect',
                    'source-card',
                    'Offizielle Gesetzesquellen',
                    'redirect-container'
                ];
                
                // Prüfe auf echte Gesetzestexte Indikatoren
                const realContentIndicators = [
                    'Art.',
                    'Artikel',
                    '§',
                    'Paragraph',
                    'Absatz',
                    'Satz',
                    'Nummer',
                    'Buchstabe'
                ];
                
                const htmlLower = html.toLowerCase();
                
                // Zähle Indikatoren
                let redirectScore = 0;
                let realScore = 0;
                
                redirectIndicators.forEach(indicator => {
                    if (htmlLower.includes(indicator.toLowerCase())) {
                        redirectScore += 2;
                    }
                });
                
                realContentIndicators.forEach(indicator => {
                    const count = (htmlLower.match(new RegExp(indicator.toLowerCase(), 'g')) || []).length;
                    if (count > 5) realScore += count / 5; // Normalisiere
                });
                
                // Prüfe Länge (längere Inhalte sind wahrscheinlich echte Gesetze)
                if (html.length > 50000) realScore += 3;
                else if (html.length > 20000) realScore += 2;
                else if (html.length > 10000) realScore += 1;
                
                console.log('📊 Content-Analyse:', { redirectScore, realScore, length: html.length });
                
                if (redirectScore > realScore) {
                    return 'redirect';
                } else if (realScore > 2) {
                    return 'real';
                } else {
                    return 'unknown';
                }
            }
            
            function parseContent(html, lawConfig, contentType) {
                try {
                    console.log('🔧 Parse HTML Content für:', lawConfig.name, '(Typ:', contentType + ')');
                    
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    if (contentType === 'redirect') {
                        parseRedirectContent(tempDiv, lawConfig);
                    } else if (contentType === 'real') {
                        parseRealContent(tempDiv, lawConfig);
                    } else {
                        // Fallback: versuche beide Methoden
                        if (!parseRealContent(tempDiv, lawConfig)) {
                            parseRedirectContent(tempDiv, lawConfig);
                        }
                    }
                    
                    renderSections();
                    console.log('✅ Parsing erfolgreich:', sections.length, 'Abschnitte');
                    
                } catch (error) {
                    console.error('❌ Parse-Fehler:', error);
                    loadFallback(lawConfig);
                }
            }
            
            function parseRedirectContent(tempDiv, lawConfig) {
                console.log('📄 Verarbeite Enhanced Redirect Content');
                
                // Erstelle eine spezielle Sektion für Redirect-Content
                sections = [{
                    number: 1,
                    title: "📄 Offizielle Quellen für " + lawConfig.shortName,
                    articles: [{
                        number: 1,
                        title: "Zugang zu aktuellen Gesetzestexten",
                        id: "redirect_info"
                    }]
                }];
                
                // Speichere den Redirect-Content direkt
                var content = tempDiv.innerHTML;
                
                // Verbessere die Darstellung
                content = content.replace(/class="container"/g, 'class="redirect-container"');
                content = content.replace(/class="sources"/g, 'class="sources-grid"');
                
                articleContents.set("redirect_info", content);
                
                return true;
            }
            
            function parseRealContent(tempDiv, lawConfig) {
                console.log('📜 Verarbeite echten Gesetzestext');
                
                try {
                    if (lawConfig.type === 'eu-regulation') {
                        return parseEURegulationStructure(tempDiv, lawConfig);
                    } else if (lawConfig.type === 'german-law') {
                        return parseGermanLawStructure(tempDiv, lawConfig);
                    }
                    return false;
                } catch (error) {
                    console.warn('⚠️ Parsing als echter Content fehlgeschlagen:', error);
                    return false;
                }
            }
            
            function parseEURegulationStructure(tempDiv, lawConfig) {
                // EU-Regulation Parsing (bereits implementiert)
                var selectors = [
                    '[id^="art_"]',
                    '[id^="article_"]',
                    '[id^="Art"]',
                    '[id*="article"]'
                ];
                
                var articleElements = [];
                for (var s = 0; s < selectors.length; s++) {
                    var found = tempDiv.querySelectorAll(selectors[s]);
                    if (found.length > 0) {
                        console.log(`✅ EU-Regulation - Gefunden mit Selector "${selectors[s]}":`, found.length, 'Artikel');
                        articleElements = found;
                        break;
                    }
                }
                
                if (articleElements.length > 0) {
                    sections = createSectionsFromElements(articleElements, lawConfig);
                    extractArticleContents(tempDiv, lawConfig);
                    return true;
                }
                
                return false;
            }
            
            function parseGermanLawStructure(tempDiv, lawConfig) {
                console.log('🏛️ Parse deutsche Gesetze-Struktur für:', lawConfig.shortName);
                
                // Suche nach verschiedenen Strukturen
                var strategies = [
                    // Strategie 1: Markdown-basierte Struktur (Bundestag GitHub)
                    function() {
                        var headers = tempDiv.querySelectorAll('h1, h2, h3, h4');
                        var paragraphs = [];
                        
                        for (var i = 0; i < headers.length; i++) {
                            var header = headers[i];
                            var text = header.textContent.trim();
                            
                            // Suche nach Paragraph-Mustern
                            var match = text.match(/§\s*(\d+)/);
                            if (match) {
                                var num = parseInt(match[1], 10);
                                paragraphs.push({
                                    number: num,
                                    title: text.replace(/§\s*\d+\s*[-–]?\s*/, ''),
                                    id: 'para_' + num,
                                    element: header
                                });
                            }
                        }
                        
                        if (paragraphs.length > 3) {
                            console.log('✅ Markdown-Struktur erkannt:', paragraphs.length, 'Paragraphen');
                            return paragraphs;
                        }
                        return null;
                    },
                    
                    // Strategie 2: HTML-basierte Struktur
                    function() {
                        var selectors = [
                            '[id^="para"]',
                            '[id^="P"]',
                            '[id*="paragraph"]',
                            'div.jurAbsatz',
                            '.norm'
                        ];
                        
                        for (var s = 0; s < selectors.length; s++) {
                            var found = tempDiv.querySelectorAll(selectors[s]);
                            if (found.length > 0) {
                                console.log('✅ HTML-Struktur erkannt mit', selectors[s] + ':', found.length, 'Elemente');
                                return Array.from(found).map(function(el, index) {
                                    return {
                                        number: index + 1,
                                        title: extractGermanTitle(el, index + 1),
                                        id: el.id || 'para_' + (index + 1),
                                        element: el
                                    };
                                });
                            }
                        }
                        return null;
                    }
                ];
                
                // Versuche Strategien nacheinander
                for (var i = 0; i < strategies.length; i++) {
                    var result = strategies[i]();
                    if (result && result.length > 0) {
                        var grouped = groupGermanParagraphs(result, lawConfig);
                        if (grouped && grouped.length > 0) {
                            sections = grouped;
                            extractGermanArticleContents(tempDiv, result, lawConfig);
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            function extractGermanArticleContents(tempDiv, paragraphs, lawConfig) {
                console.log('📄 Extrahiere deutsche Paragraph-Inhalte');
                
                for (var i = 0; i < paragraphs.length; i++) {
                    var para = paragraphs[i];
                    var content = '';
                    
                    if (para.element) {
                        // Sammle Content ab diesem Element bis zum nächsten
                        var current = para.element;
                        var contentElements = [current];
                        
                        // Sammle nachfolgende Elemente bis zum nächsten Header
                        var next = current.nextElementSibling;
                        while (next && !isHeaderElement(next)) {
                            contentElements.push(next);
                            next = next.nextElementSibling;
                        }
                        
                        // Kombiniere Content
                        content = contentElements.map(function(el) {
                            return el.outerHTML;
                        }).join('\n');
                        
                        // Formatiere als Markdown-Content
                        content = '<div class="markdown-content">' + content + '</div>';
                    } else {
                        // Fallback: einfacher Text
                        content = '<div class="markdown-content"><p><em>Paragraph-Inhalt nicht verfügbar. ' +
                                'Besuchen Sie die offiziellen Quellen für den vollständigen Text.</em></p></div>';
                    }
                    
                    if (content.trim()) {
                        articleContents.set(para.id, content);
                    }
                }
                
                console.log('✅ Deutsche Paragraph-Inhalte extrahiert:', articleContents.size);
            }
            
            function isHeaderElement(element) {
                if (!element) return false;
                var tagName = element.tagName.toLowerCase();
                return ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName) ||
                       element.textContent.match(/§\s*\d+/) ||
                       element.classList.contains('header') ||
                       element.classList.contains('titel');
            }
            
            function extractGermanTitle(element, paraNum) {
                if (!element) return '§ ' + paraNum;
                
                var text = element.textContent.trim();
                
                // Bereinige den Titel
                text = text.replace(/^§\s*\d+\s*[-–]?\s*/i, '');
                
                if (text.length > 2 && text.length < 200) {
                    return text;
                }
                
                return '§ ' + paraNum;
            }
            
            function groupGermanParagraphs(allParagraphs, lawConfig) {
                // Sortiere nach Paragraph-Nummer
                allParagraphs.sort(function(a, b) { return a.number - b.number; });
                
                // Spezifische Gruppierung je nach Gesetz
                switch (lawConfig.shortName) {
                    case 'GwG':
                        return groupGwGParagraphs(allParagraphs);
                    case 'KWG':
                        return groupKWGParagraphs(allParagraphs);
                    case 'StGB':
                        return groupStGBParagraphs(allParagraphs);
                    default:
                        return groupDefaultGermanParagraphs(allParagraphs);
                }
            }
            
            function groupGwGParagraphs(allParagraphs) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 5 },
                    { title: "Sorgfaltspflichten", start: 6, end: 15 },
                    { title: "Meldepflichten", start: 16, end: 20 },
                    { title: "Organisationspflichten", start: 21, end: 30 },
                    { title: "Aufsicht", start: 31, end: 50 },
                    { title: "Straf- und Bußgeldvorschriften", start: 51, end: 70 }
                ];
                return createSectionsFromRanges(ranges, allParagraphs);
            }
            
            function groupKWGParagraphs(allParagraphs) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 10 },
                    { title: "Erlaubnis und Beaufsichtigung", start: 11, end: 30 },
                    { title: "Geschäftstätigkeit", start: 31, end: 50 },
                    { title: "Sondervorschriften", start: 51, end: 100 }
                ];
                return createSectionsFromRanges(ranges, allParagraphs);
            }
            
            function groupStGBParagraphs(allParagraphs) {
                var ranges = [
                    { title: "Geldwäsche-relevante Bestimmungen", start: 260, end: 262 },
                    { title: "Weitere Straftatbestände", start: 1, end: 300 }
                ];
                return createSectionsFromRanges(ranges, allParagraphs);
            }
            
            function groupDefaultGermanParagraphs(allParagraphs) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 10 },
                    { title: "Hauptteil", start: 11, end: 50 },
                    { title: "Weitere Bestimmungen", start: 51, end: 100 },
                    { title: "Schlussbestimmungen", start: 101, end: 999 }
                ];
                return createSectionsFromRanges(ranges, allParagraphs);
            }
            
            function createSectionsFromRanges(ranges, allArticles) {
                var result = [];
                
                for (var i = 0; i < ranges.length; i++) {
                    var range = ranges[i];
                    var sectionArticles = [];
                    
                    for (var j = 0; j < allArticles.length; j++) {
                        var article = allArticles[j];
                        if (article.number >= range.start && article.number <= range.end) {
                            sectionArticles.push(article);
                        }
                    }
                    
                    if (sectionArticles.length > 0) {
                        result.push({
                            number: i + 1,
                            title: range.title,
                            articles: sectionArticles
                        });
                    }
                }
                
                return result;
            }
            
            // Bereits implementierte Funktionen beibehalten...
            function createSectionsFromElements(elements, lawConfig) {
                var allArticles = [];
                var processedIds = new Set();
                
                for (var i = 0; i < elements.length; i++) {
                    var element = elements[i];
                    
                    if (processedIds.has(element.id)) continue;
                    processedIds.add(element.id);
                    
                    var match = element.id.match(/art[icle]*[_-]?(\d+)/i);
                    if (match) {
                        var num = parseInt(match[1], 10);
                        if (num > 0 && num < 1000) {
                            var title = extractTitle(element, num);
                            
                            allArticles.push({
                                number: num,
                                title: title,
                                id: element.id
                            });
                            
                            console.log(`📄 Artikel ${num}: ${title}`);
                        }
                    }
                }
                
                allArticles.sort(function(a, b) { return a.number - b.number; });
                return groupArticles(allArticles, lawConfig);
            }
            
            function extractTitle(element, articleNum) {
                var selectors = ['.oj-sti-art', '.eli-title', '.title', 'h1', 'h2', 'h3', 'strong', 'b'];
                
                for (var s = 0; s < selectors.length; s++) {
                    var titleEl = element.querySelector ? element.querySelector(selectors[s]) : null;
                    if (!titleEl && element.textContent) {
                        var text = element.textContent.trim();
                        if (text.length > 3 && text.length < 200) {
                            return text.replace(/^Artikel\s+\d+\s*[-–]?\s*/i, '');
                        }
                    }
                    
                    if (titleEl) {
                        var text = titleEl.textContent.trim();
                        if (text.length > 2 && text.length < 200) {
                            return text.replace(/^Artikel\s+\d+\s*[-–]?\s*/i, '');
                        }
                    }
                }
                
                return 'Artikel ' + articleNum;
            }
            
            function groupArticles(allArticles, lawConfig) {
                switch (lawConfig.shortName) {
                    case 'GDPR':
                        return groupGDPRArticles(allArticles);
                    case 'AI Act':
                        return groupAIActArticles(allArticles);
                    case 'DSA':
                        return groupDSAArticles(allArticles);
                    default:
                        return groupAMLArticles(allArticles);
                }
            }
            
            function groupGDPRArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 4 },
                    { title: "Grundsätze", start: 5, end: 11 },
                    { title: "Rechte der betroffenen Person", start: 12, end: 23 },
                    { title: "Verantwortlicher und Auftragsverarbeiter", start: 24, end: 43 },
                    { title: "Übermittlung an Drittländer", start: 44, end: 50 },
                    { title: "Unabhängige Aufsichtsbehörden", start: 51, end: 76 },
                    { title: "Zusammenarbeit und Kohärenz", start: 77, end: 84 },
                    { title: "Rechtsbehelfe und Sanktionen", start: 85, end: 91 },
                    { title: "Schlussbestimmungen", start: 92, end: 99 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function groupAMLArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 8 },
                    { title: "Interne Strategien, Verfahren und Kontrollen", start: 9, end: 18 },
                    { title: "Sorgfaltsprüfung in Bezug auf Kunden", start: 19, end: 50 },
                    { title: "Transparenz des wirtschaftlichen Eigentums", start: 51, end: 68 },
                    { title: "Meldepflichten", start: 69, end: 75 },
                    { title: "Schlussbestimmungen", start: 76, end: 95 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function groupAIActArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 12 },
                    { title: "Verbotene KI-Praktiken", start: 13, end: 15 },
                    { title: "Hochrisiko-KI-Systeme", start: 16, end: 51 },
                    { title: "Transparenzpflichten", start: 52, end: 54 },
                    { title: "Governance und Umsetzung", start: 55, end: 78 },
                    { title: "Sanktionen", start: 79, end: 83 },
                    { title: "Schlussbestimmungen", start: 84, end: 113 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function groupDSAArticles(allArticles) {
                var ranges = [
                    { title: "Allgemeine Bestimmungen", start: 1, end: 6 },
                    { title: "Pflichten der Vermittlungsdienste", start: 7, end: 25 },
                    { title: "Online-Plattformen", start: 26, end: 39 },
                    { title: "Sehr große Online-Plattformen", start: 40, end: 68 },
                    { title: "Durchsetzung", start: 69, end: 87 },
                    { title: "Schlussbestimmungen", start: 88, end: 94 }
                ];
                
                return createSectionsFromRanges(ranges, allArticles);
            }
            
            function extractArticleContents(tempDiv, lawConfig) {
                var selectors = lawConfig.type === 'eu-regulation' ? 
                    ['[id^="art_"]', '[id^="article_"]', '[id^="Art"]', '[id*="article"]'] :
                    ['[id^="para"]', '[id^="P"]', '[id*="paragraph"]', 'div.jurAbsatz', '.norm'];
                
                var articleElements = [];
                for (var s = 0; s < selectors.length; s++) {
                    var found = tempDiv.querySelectorAll(selectors[s]);
                    if (found.length > 0) {
                        articleElements = found;
                        break;
                    }
                }
                
                console.log('📄 Extrahiere Inhalte für', articleElements.length, 
                          lawConfig.type === 'german-law' ? 'Paragraphen' : 'Artikel');

                for (var i = 0; i < articleElements.length; i++) {
                    var article = articleElements[i];
                    var content = article.cloneNode(true);

                    // Bereinige Content
                    var unwanted = content.querySelectorAll('script, style, .nav, .navigation, .breadcrumb');
                    for (var u = 0; u < unwanted.length; u++) {
                        unwanted[u].remove();
                    }

                    // Formatiere je nach Typ
                    if (lawConfig.type === 'eu-regulation') {
                        formatEUContent(content);
                    } else if (lawConfig.type === 'german-law') {
                        formatGermanContent(content);
                    }

                    var cleanContent = content.innerHTML.trim();
                    if (cleanContent) {
                        // Wrappen in markdown-content für bessere Darstellung
                        cleanContent = '<div class="markdown-content">' + cleanContent + '</div>';
                        articleContents.set(article.id, cleanContent);
                    }
                }

                console.log('✅ Artikel-Inhalte extrahiert:', articleContents.size);
            }
            
            function formatEUContent(contentDiv) {
                // EU-Formatierung (bereits implementiert)
                var normalPs = contentDiv.querySelectorAll('p');
                for (var p = 0; p < normalPs.length; p++) {
                    var para = normalPs[p];
                    var text = para.textContent.trim();
                    
                    var match = text.match(/^\((\d+)\)\s+(.+)$/);
                    if (match) {
                        var absatzNum = match[1];
                        var absatzText = match[2];
                        
                        para.innerHTML = 
                            '<div style="margin: 0.5em 0; padding-left: 1.5em; position: relative;">' +
                            '<span style="position: absolute; left: 0; font-weight: 500; color: #063AA8;">(' + absatzNum + ')</span>' +
                            absatzText +
                            '</div>';
                    }
                }
            }
            
            function formatGermanContent(contentDiv) {
                // Deutsche Formatierung (bereits implementiert)
                var paragraphs = contentDiv.querySelectorAll('p, .absatz, .jurAbsatz');
                for (var p = 0; p < paragraphs.length; p++) {
                    var para = paragraphs[p];
                    var text = para.textContent.trim();
                    
                    var match = text.match(/^\((\d+)\)\s+(.+)$/);
                    if (match) {
                        var absatzNum = match[1];
                        var absatzText = match[2];
                        
                        para.innerHTML = 
                            '<div style="margin: 0.5em 0; padding-left: 1.5em; position: relative;">' +
                            '<span style="position: absolute; left: 0; font-weight: 500; color: #B91C1C;">(' + absatzNum + ')</span>' +
                            absatzText +
                            '</div>';
                    }
                }
            }
            
            function loadFallback(lawConfig) {
                console.log('🔄 Lade Fallback-Content für:', lawConfig.name);
                
                if (lawConfig.shortName === 'GDPR') {
                    sections = createGDPRFallback();
                } else if (lawConfig.shortName === 'AI Act') {
                    sections = createAIActFallback();
                } else if (lawConfig.shortName === 'DSA') {
                    sections = createDSAFallback();
                } else {
                    sections = createAMLFallback();
                }
                
                renderSections();
            }
            
            function createGDPRFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand und Ziele", id: "art_1" },
                        { number: 2, title: "Sachlicher Anwendungsbereich", id: "art_2" },
                        { number: 3, title: "Räumlicher Anwendungsbereich", id: "art_3" },
                        { number: 4, title: "Begriffsbestimmungen", id: "art_4" }
                    ]
                }, {
                    number: 2,
                    title: "Grundsätze",
                    articles: [
                        { number: 5, title: "Grundsätze für die Verarbeitung personenbezogener Daten", id: "art_5" },
                        { number: 6, title: "Rechtmäßigkeit der Verarbeitung", id: "art_6" }
                    ]
                }];
            }
            
            function createAMLFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand", id: "art_1" },
                        { number: 2, title: "Begriffsbestimmungen", id: "art_2" },
                        { number: 3, title: "Anwendungsbereich", id: "art_3" }
                    ]
                }];
            }
            
            function createAIActFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand und Anwendungsbereich", id: "art_1" },
                        { number: 3, title: "Begriffsbestimmungen", id: "art_3" },
                        { number: 4, title: "Änderungen von Anhängen", id: "art_4" }
                    ]
                }];
            }
            
            function createDSAFallback() {
                return [{
                    number: 1,
                    title: "Allgemeine Bestimmungen",
                    articles: [
                        { number: 1, title: "Gegenstand und Anwendungsbereich", id: "art_1" },
                        { number: 2, title: "Begriffsbestimmungen", id: "art_2" },
                        { number: 3, title: "Anwendungsbereich", id: "art_3" }
                    ]
                }];
            }
            
            function renderSections(filter) {
                if (!sections.length || !mainContent) return;
                
                var searchText = (filter || '').toLowerCase();
                var html = '';
                var hasResults = false;
                var lawConfig = AVAILABLE_LAWS[currentLaw];
                
                for (var i = 0; i < sections.length; i++) {
                    var section = sections[i];
                    var sectionHtml = '';
                    var sectionHasResults = false;
                    
                    for (var j = 0; j < section.articles.length; j++) {
                        var article = section.articles[j];
                        var searchableText = (getArticlePrefix(lawConfig) + article.number + ' ' + article.title).toLowerCase();
                        var titleMatch = !searchText || searchableText.indexOf(searchText) !== -1;
                        var contentMatch = false;
                        
                        if (!titleMatch && searchText) {
                            var content = articleContents.get(article.id);
                            if (content) {
                                var contentText = content.toLowerCase();
                                contentMatch = contentText.indexOf(searchText) !== -1;
                            }
                        }
                        
                        if (titleMatch || contentMatch) {
                            var highlightedTitle = searchText ? highlightText(article.title, searchText) : article.title;
                            var badgeClass = getBadgeClass(lawConfig.shortName);
                            var contentTypeIndicator = getContentTypeIndicator();
                            
                            sectionHtml += '<div class="euaml-article' + (contentMatch ? ' euaml-content-match' : '') + '" data-article-id="' + article.id + '">';
                            sectionHtml += '<div class="euaml-article-title">';
                            sectionHtml += '<span>' + getArticlePrefix(lawConfig) + article.number + ' - ' + highlightedTitle + '</span>';
                            sectionHtml += '<div class="euaml-article-meta">';
                            sectionHtml += '<span class="law-badge ' + badgeClass + '">' + lawConfig.shortName + '</span>';
                            sectionHtml += contentTypeIndicator;
                            if (contentMatch) {
                                sectionHtml += '<span style="font-size: 0.85em; color: #0056b3; margin-left: 0.5em; padding: 2px 6px; border-radius: 4px; background-color: #e6f3ff;">(Treffer im Inhalt)</span>';
                            }
                            sectionHtml += '</div>';
                            sectionHtml += '</div>';
                            sectionHtml += '<div class="euaml-article-content"></div>';
                            sectionHtml += '</div>';
                            sectionHasResults = true;
                        }
                    }
                    
                    if (sectionHasResults) {
                        hasResults = true;
                        html += '<div class="euaml-section">';
                        html += '<div class="euaml-section-title">Abschnitt ' + section.number + ': ' + section.title;
                        if (lastUpdateTime) {
                            html += '<span class="euaml-update-time">Update: ' + lastUpdateTime.toLocaleString('de-DE') + '</span>';
                        }
                        html += '</div>';
                        html += sectionHtml;
                        html += '</div>';
                    }
                }
                
                if (!hasResults && searchText) {
                    html = '<div style="text-align: center; padding: 40px; color: #666;">Keine Ergebnisse für "' + filter + '" gefunden.</div>';
                }
                
                mainContent.innerHTML = html;
                bindEvents();
                console.log('✅ Sections gerendert mit Filter:', filter);
            }
            
            function getArticlePrefix(lawConfig) {
                return lawConfig.type === 'german-law' ? '§ ' : 'Art. ';
            }
            
            function getContentTypeIndicator() {
                if (currentContentType === 'real') {
                    return '<span class="content-type-indicator">Echt</span>';
                } else if (currentContentType === 'redirect') {
                    return '<span class="content-type-indicator redirect">Redirect</span>';
                }
                return '';
            }
            
            function getBadgeClass(shortName) {
                var badgeClasses = {
                    'EU-GwVO': 'eu-aml',
                    'GDPR': 'gdpr', 
                    'AI Act': 'ai-act',
                    'DSA': 'dsa',
                    'GwG': 'de-gwg',
                    'KWG': 'de-kwg',
                    'ZAG': 'de-zag',
                    'AWG': 'de-awg',
                    'AWV': 'de-awv',
                    'StGB': 'de-stgb',
                    'VAG': 'de-vag',
                    'KAGB': 'de-kagb',
                    'WpHG': 'de-wphg',
                    'EU-SanktDG': 'de-sanktdg'
                };
                
                return badgeClasses[shortName] || 'default';
            }
            
            function highlightText(text, searchTerm) {
                if (!searchTerm || searchTerm.length < 1) return text;
                var escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                var regex = new RegExp('(' + escapedTerm + ')', 'gi');
                return text.replace(regex, '<span class="euaml-search-highlight">$1</span>');
            }
            
            function bindEvents() {
                var articles = mainContent.querySelectorAll('.euaml-article');
                
                for (var i = 0; i < articles.length; i++) {
                    articles[i].addEventListener('click', function(e) {
                        var selection = window.getSelection();
                        if (selection && selection.toString().trim().length > 0) {
                            return;
                        }
                        
                        var contentDiv = this.querySelector('.euaml-article-content');
                        if (contentDiv && contentDiv.contains(e.target)) {
                            return;
                        }
                        
                        toggleArticle(this);
                    });
                }
            }
            
            function toggleArticle(articleElement) {
                var articleId = articleElement.getAttribute('data-article-id');
                var wasActive = articleElement.classList.contains('euaml-active');
                
                var allArticles = mainContent.querySelectorAll('.euaml-article');
                for (var i = 0; i < allArticles.length; i++) {
                    if (allArticles[i] !== articleElement) {
                        allArticles[i].classList.remove('euaml-active');
                    }
                }
                
                if (wasActive) {
                    articleElement.classList.remove('euaml-active');
                    return;
                }
                
                articleElement.classList.add('euaml-active');
                loadArticleContent(articleElement, articleId);
            }
            
            function loadArticleContent(articleElement, articleId) {
                var contentDiv = articleElement.querySelector('.euaml-article-content');
                var content = articleContents.get(articleId);
                
                if (content) {
                    var searchTerm = searchInput ? searchInput.value.trim() : '';
                    var displayContent = content;
                    
                    if (searchTerm) {
                        displayContent = highlightInContent(content, searchTerm);
                    }
                    
                    contentDiv.innerHTML = 
                        '<div>' + displayContent + '</div>' +
                        '<div style="padding-top: 10px; border-top: 1px solid #eee; margin-top: 15px;">' +
                        '<button class="euaml-close-btn" onclick="this.closest(\'.euaml-article\').classList.remove(\'euaml-active\')">Schließen</button>' +
                        '</div>';
                } else {
                    contentDiv.innerHTML = '<div><p><em>Artikel-Inhalt nicht verfügbar.</em></p></div>';
                }
            }
            
            function highlightInContent(content, searchTerm) {
                if (!searchTerm || searchTerm.length < 2) return content;

                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;

                var searchTerms = searchTerm.toLowerCase().split(/\s+/).filter(function(term) {
                    return term.length > 1;
                });

                var walker = document.createTreeWalker(
                    tempDiv,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                var textNodes = [];
                var node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                for (var i = 0; i < textNodes.length; i++) {
                    var textNode = textNodes[i];
                    var text = textNode.textContent;
                    var highlightedText = text;

                    for (var j = 0; j < searchTerms.length; j++) {
                        var term = searchTerms[j];
                        var escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        var regex = new RegExp('(' + escapedTerm + ')', 'gi');
                        highlightedText = highlightedText.replace(regex, '<span class="euaml-search-highlight">$1</span>');
                    }

                    if (highlightedText !== text) {
                        var span = document.createElement('span');
                        span.innerHTML = highlightedText;
                        textNode.parentNode.replaceChild(span, textNode);
                    }
                }

                return tempDiv.innerHTML;
            }
            
            function handleSearch(searchText) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    renderSections(searchText);
                }, 300);
            }
            
            function initEventListeners() {
                if (lawSelector) {
                    lawSelector.addEventListener('change', function(e) {
                        currentLaw = e.target.value;
                        var lawConfig = AVAILABLE_LAWS[currentLaw];
                        
                        if (searchInput) {
                            searchInput.placeholder = 'Suche in ' + lawConfig.shortName + ' nach Artikeln oder Begriffen...';
                            searchInput.value = '';
                        }
                        
                        articleContents.clear();
                        sections = [];
                        currentContentType = 'unknown';
                        
                        loadFromGitHub(lawConfig);
                    });
                }
                
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        handleSearch(e.target.value.trim());
                    });
                }
                
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function() {
                        var lawConfig = AVAILABLE_LAWS[currentLaw];
                        articleContents.clear();
                        sections = [];
                        currentContentType = 'unknown';
                        
                        loadFromGitHub(lawConfig);
                    });
                }
            }
            
            function init() {
                console.log('🚀 Initialisiere Enhanced Navigator...');
                
                if (!initElements()) {
                    console.error('❌ DOM-Elemente nicht gefunden');
                    return;
                }
                
                initEventListeners();
                
                // Lade Standard-Gesetz
                var lawConfig = AVAILABLE_LAWS[currentLaw];
                loadFromGitHub(lawConfig);
                
                console.log('✅ Enhanced Navigator initialisiert');
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>
